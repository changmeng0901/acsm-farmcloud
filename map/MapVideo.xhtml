<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:c="http://java.sun.com/jstl/core">
    <link rel="stylesheet" type="text/css" media="screen" href="#{request.contextPath}/asset/css/bootstrap-select.min.css"/>
    <link href="#{request.contextPath}/asset/css/bootstrap3.min.css" rel="stylesheet"/>
	<link href="#{request.contextPath}/asset/css/datetimepicker.css" rel="stylesheet"/>
	<link rel="stylesheet" type="text/css" href="#{request.contextPath}/asset/css/style_new_map.css"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/asset/css/style_map.css"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/asset/css/msgModal.css"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/asset/css/base.css"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/asset/css/mapRtArea.css"/>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/jquery.js"></script>
	<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap.min.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap-select.min.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap-datetimepicker.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap-datetimepicker.zh-CN.js"></script>
<!--  #{mapHome.mapWork()} -->
<style>  
html{background:#fff;}
.se_selt170{width: 170px;}
.se_selt170 .dropdown-menu .form-control{ width: 100%; box-sizing: border-box;}
.se_selt170 .bootstrap-select.btn-group .dropdown-menu{ min-width: 100%; width: 100%;}
.se_selt170 .bootstrap-select:not([class*=span]):not([class*=col-]):not([class*=form-control]):not(.input-group-btn){width: 100%; min-width: 100%; max-width: 200px;}
.pl5{ padding-left: 5px;}
.pt8{ padding-top: 8px;}
.star_red{ color: #f00; font-family: "宋体"; line-height: 32px;}
.jScrollbar_mask .nw170{width:170px; box-sizing: border-box;}
.jScrollbar_mask .font_txt{line-height:32px;}
.jScrollbar_mask .base_name_a{background: #FFF;font-family:'微软雅黑';font-size: 14px;}
.jScrollbar_mask .use_field{margin-top: 24px;font-size:14px;}
.jScrollbar_mask .land_test_{font-size:14px;}
.jScrollbar_mask .panel_table{ width: 100%;}
.jScrollbar_mask .panel_table td{ padding: 8px 0;}
.jScrollbar_mask .panel_table .tc_font{font-size: 12px;color: #211f1f; vertical-align: middle;padding-right: 10px; width: 85px; box-sizing: border-box; text-align: right;}
.jScrollbar_mask .panel_table .tc_strong{ padding-left: 0;}
.jScrollbar_mask .panel_table .nw82{width:82px; padding-left: 5px; padding-right: 5px; box-sizing: border-box;}
.jScrollbar_mask .panel_table .nw170{width:170px; box-sizing: border-box;}
.jScrollbar_mask .panel_table .nw200{width:200px; box-sizing: border-box;}
.jScrollbar_mask .panel_table .font_txt{line-height:32px;}
.jScrollbar_mask .panel_table .base_name_a{background: #FFF;font-family:'微软雅黑';font-size: 14px;}
.jScrollbar_mask .panel_table .use_field{margin-top: 24px;font-size:14px;}
.jScrollbar_mask .panel_table .land_test_{font-size:14px;}
</style>  
<!-- #{mapHome.videoMess()} -->

<div class="jScrollbar_mask" style="center: center;">
<div class="tc_ul" >
	<table class="panel_table" cellpadding="0" cellspacing="0">
		<tr>
           	<td class="tc_font">基地</td>
            <td class="tc_strong">
           		<input type="hidden" value="#{mapHome.video_id}" id="video_id" name="video_id"/>
           		<input type="hidden" value="#{mapHome.video_base_id}" id="video_base_id" name="video_base_id" />
           		<input type="hidden" value="" id="video_index" name="video_index" />
           		<input type="hidden" value="#{mapHome.video_coordinateX}" id="video_coordinateX" name="video_coordinateX" />
           		<input type="hidden" value="#{mapHome.video_coordinateY}" id="video_coordinateY" name="video_coordinateY" />
               	<input type="text" id="video_base_name" name="video_base_name" value="#{mapHome.video_base_name}" style="background: none repeat scroll 0 0 #FFFFFF;font-family: '微软雅黑';font-size: 14px;" readonly="readonly"/>
            </td>
        </tr>
        <tr>
          	<td class="tc_font">分区</td>
            <td class="tc_strong">
              	<input type="hidden" id="video_partition_id" name="video_partition_id" /> 
                <input type="text" id="video_partition_name" name="video_partition_name" value="#{mapHome.video_partition_name}" style="background: none repeat scroll 0 0 #FFFFFF;font-family: '微软雅黑';font-size: 14px;" readonly="readonly"/>
            </td>
        </tr>
        <tr>
          	<td class="tc_font">区域</td>
            <td class="tc_strong">
              	<input type="hidden" id="video_tunnel_id" name="video_tunnel_id" /> 
                <input type="text" id="video_tunnel_name" name="video_tunnel_name" value="#{mapHome.video_tunnel_name}" style="background: none repeat scroll 0 0 #FFFFFF;font-family: '微软雅黑';font-size: 14px;" readonly="readonly"/>
            </td>
        </tr>
        <tr>
          	<td class="tc_font">设备名称</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170 fl" id="video_name" name="video_name" value="#{mapHome.video.name}"/>
                <p class="star_red fl pl5">*</p>
            </td>
        </tr>
        <tr>
          	<td class="tc_font">设备厂商</td>
            <td class="tc_strong">
	            <div class="se_selt170">
					<select id="video_type_id" name="video_type_id"  class="selectpicker" onchange="changeVideoType(this)">
	                   	<a4j:repeat value="#{mapHome.videoTypeList}" var="f" >
	                   		<option value="#{f.id}">#{f.name}</option>
	                   	</a4j:repeat>
	                </select>
				</div>
            </td>
        </tr>
        <tr name="hk">
          	<td class="tc_font">设备类型</td>
            <td class="tc_strong">
             	<div class="se_selt170">
					<select class="selectpicker" id="video_access_way" name="video_access_way" style="width:146px;"  onchange="changeHtml(this)">
						<option value="1">硬盘录像机</option>
						<option value="3">新硬盘录像机</option>
					</select>
                </div>
            </td>
        </tr>
        <tr class="video_show video_show1">
          	<td class="tc_font">IP/域名</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170 fl" id="video_app_ip" name="video_app_ip" value="#{mapHome.video.appIp}" />
                <p class="fl pl5 pt8">
                	<a id="help" href="#{request.contextPath}/help/hkVideoHelp.seam" target="_blank"><img src="#{request.contextPath}/asset/images/ico_help.png" /></a>
                </p>
            </td>
        </tr>
        <tr class="tc_li video_show video_show1" name="new_hk">
          	<td class="tc_font">HTTP端口号</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_app_web_port" name="video_app_web_port" value="#{mapHome.video.appWebPort}" />
            </td>
        </tr>
        <tr class="video_show video_show1" name="new_sp">
          	<td class="tc_font">RTSP端口号</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_device_port" name="video_device_port" value="#{mapHome.video.devicePort}"/>
            </td>
        </tr>
        <tr class="video_show video_show1" name="new_fw">
          	<td class="tc_font ziyuanid">服务端口</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_app_port" name="video_app_port" value="#{mapHome.video.appPort}"/>
            </td>
        </tr>
        <tr class="video_show video_show1">
          	<td class="tc_font">用户名</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_app_username" name="video_app_username" value="#{mapHome.video.appUsername}"/>
            </td>
        </tr>
        <tr class="video_show video_show1">
          	<td class="tc_font">密码</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_app_password" name="video_app_password" value="#{mapHome.video.appPassword}"/>
            </td>
        </tr>
        <tr class="video_show video_show1" name="hk">
          	<td class="tc_font">通道号</td>
            <td class="tc_strong" >
            	<div class="fl">
	                <input type="text" class="form-control nw82" id="video_app_device_video_channel_no" name="video_app_device_video_channel_no" value="#{mapHome.video.appDeviceVideoChannelNo}"/>
	                <select id="channels" style="width: 82px; height: 30px;" onchange="channelChange();"></select>
                </div>
                <div class="fl pl5">
                	<input id="getOn" type="button" class="btn btn-default nw82" value="获取通道号" onclick="getAppDeviceVideoChannelNo();" />
                </div>
            </td>
        </tr>
        <tr class="video_show video_show1" name="sp">
            <td class="tc_font">拍照上传编号</td>
            <td class="tc_strong">
                <input type="text" class="form-control nw170" id="video_sn" name="video_sn" value="#{mapHome.video.sn}"/>
            </td>
        </tr>
	</table>
</div>
</div>
<div class="clear"></div>
<div class="tc_bottom" style="position: fixed;bottom:0;display:none;">
<ui:fragment rendered="#{s:hasRole('map_edit')}">
	<input type="button" class="btn btn-primary video_btn_ok" value="保存" onclick="checkSubmit2();"/>
	<input type="button" class="btn btn-default video_btn_cancel" value="取消" onclick="window.parent.video_no()"/>
	<input type="button" class="btn btn-default video_btn_delete" value="删除" onclick="videoDelete()" style="#{empty mapHome.video_id?'display:none':''}"/>
</ui:fragment>
</div>
<div id="divPlugin" class="plugin" style="width:0;height:0;"></div>

<a4j:form>
	<a4j:queue requestDelay="10" ignoreDupResponses="true"/>
	<a4j:jsFunction name="videoSnChick" action="#{mapHome.videoSnChick()}" data="#{mapHome.videoMessage}" oncomplete="huidiao2(data);">
		<a4j:actionparam name="id" assignTo="#{mapHome.video_id}"/>
		<a4j:actionparam name="sn" assignTo="#{mapHome.video_sn}"/>
	</a4j:jsFunction>
	<a4j:jsFunction name="saveVideo" action="#{mapHome.videoSave()}" data="#{mapHome.videoMessage}" oncomplete="huidiao(data);">
		<a4j:actionparam name="id" assignTo="#{mapHome.video_id}"/>
		<a4j:actionparam name="name" assignTo="#{mapHome.video_name}"/>
		<a4j:actionparam name="typeId" assignTo="#{mapHome.video_type_id}"/>
		<a4j:actionparam name="accessWay" assignTo="#{mapHome.video_access_way}"/>
		<a4j:actionparam name="appIp" assignTo="#{mapHome.video_app_ip}"/>
		<a4j:actionparam name="appWebPort" assignTo="#{mapHome.video_app_web_port}"/>
		<a4j:actionparam name="devicePort" assignTo="#{mapHome.video_device_port}"/>
		<a4j:actionparam name="appPort" assignTo="#{mapHome.video_app_port}"/>
		<a4j:actionparam name="appUsername" assignTo="#{mapHome.video_app_username}"/>
		<a4j:actionparam name="appPassword" assignTo="#{mapHome.video_app_password}"/>
		<a4j:actionparam name="channelNo" assignTo="#{mapHome.video_app_device_video_channel_no}"/>
		<a4j:actionparam name="sn" assignTo="#{mapHome.video_sn}"/>
		<a4j:actionparam name="baseId" assignTo="#{mapHome.video_base_id}"/>
		<a4j:actionparam name="coordinateX" assignTo="#{mapHome.video_coordinateX}"/>
		<a4j:actionparam name="coordinateY" assignTo="#{mapHome.video_coordinateY}"/>
		<a4j:actionparam name="partitionId" assignTo="#{mapHome.video_partition_id}"/>
		<a4j:actionparam name="tunnelId" assignTo="#{mapHome.video_tunnel_id}"/>
	</a4j:jsFunction>
	<a4j:jsFunction name="deleteVideo" action="#{mapHome.videoDelete()}" data="#{mapHome.videoMessage}" oncomplete="deleteNext();">
		<a4j:actionparam name="id" assignTo="#{mapHome.video_id}"/>
	</a4j:jsFunction>
</a4j:form>
<script type="text/javascript">
//<![CDATA[
_Q = jQuery.noConflict(); 

var workpath = "#{request.contextPath}";
window.onload = function () {
	_Q('.selectpicker').selectpicker();
   
	var typeId='#{mapHome.video.deviceTypeId}';
	var accessWay='#{mapHome.video.accessWay}';
	if(typeId!=''&&typeId!=null){
		_Q("#video_type_id").selectpicker("val",typeId);
		if(typeId == '301'){
			if(accessWay!=null&&accessWay!=''){
				_Q("#video_access_way").selectpicker("val",accessWay);
			}else{
				_Q("#video_access_way").selectpicker("val",3)
			}
		}
		changeVideoType(typeId);
	}else{
		 var obj = document.getElementById("video_type_id");
		 _Q("#video_access_way").selectpicker("val",3)
		 changeVideoType(obj);
	}
	_Q('#channels').hide();
  };

function getAppDeviceVideoChannelNo(){
	var appIp = _Q('#video_app_ip').val();
	var appUsername = _Q('#video_app_username').val();
	var appPassword = _Q('#video_app_password').val();
	var HttpPort = _Q('#video_app_web_port').val();
	if(appIp==null||appIp==''||appUsername==null||appUsername==''||appPassword==null||appPassword==''||HttpPort==null||HttpPort==''){
		alert('您添加的参数不完整，获取不到通道号');
	}else{
		_Q('#video_app_device_video_channel_no').hide();
		_Q('#channels').show();
		// 检查插件是否已经安装过
		if (-1 == WebVideoCtrl.I_CheckPluginInstall()) {
			alert("您还未安装过插件，双击开发包目录里的WebComponents.exe安装！");
			return;
		}
		// 初始化插件参数及插入插件
		WebVideoCtrl.I_InitPlugin(500, 300, {
	        iWndowType: 2,
			cbSelWnd: function (xmlDoc) {
				g_iWndIndex = _Q(xmlDoc).find("SelectWnd").eq(0).text();
			}
		});
		WebVideoCtrl.I_InsertOBJECTPlugin("divPlugin");
		_Q('embed').width(0).height(0);  
		_Q('.selectpicker').selectpicker();
		var iRet = WebVideoCtrl.I_Login(appIp, 1, HttpPort, appUsername, appPassword, {
				success: function (xmlDoc) {
					 var szIP = appIp,
						oSel = _Q("#channels").empty(),
						nAnalogChannel = 0;
					if ("" == szIP) {
						return;
					}
					// 模拟通道
					WebVideoCtrl.I_GetAnalogChannelInfo(szIP, {
						async: false,
						success: function (xmlDoc) {
							var oChannels = _Q(xmlDoc).find("VideoInputChannel");
							nAnalogChannel = oChannels.length;

							_Q.each(oChannels, function (i) {
								var id = parseInt(_Q(this).find("id").eq(0).text(), 10),
									name = _Q(this).find("name").eq(0).text();
								if ("" == name) {
									name = "Camera " + (id < 9 ? "0" + id : id);
								}
								oSel.append("<option value='" + id + "' bZero='false'>" + name + "</option>");
							});
						},
						error: function () {
						}
					});
					// 数字通道
					WebVideoCtrl.I_GetDigitalChannelInfo(szIP, {
						async: false,
						success: function (xmlDoc) {
							var oChannels = _Q(xmlDoc).find("InputProxyChannelStatus");

							_Q.each(oChannels, function (i) {
								var id = parseInt(_Q(this).find("id").eq(0).text(), 10),
									name = _Q(this).find("name").eq(0).text(),
									online = _Q(this).find("online").eq(0).text();
								if ("false" == online) {// 过滤禁用的数字通道
									return true;
								}
								if ("" == name) {
									name = "IPCamera " + ((id - nAnalogChannel) < 9 ? "0" + (id - nAnalogChannel) : (id - nAnalogChannel));
								}
								oSel.append("<option value='" + id + "' bZero='false'>" + name + "</option>");
							});
						},
						error: function () {
						}
					});
					// 零通道
					WebVideoCtrl.I_GetZeroChannelInfo(szIP, {
						async: false,
						success: function (xmlDoc) {
							var oChannels = _Q(xmlDoc).find("ZeroVideoChannel");
							
							_Q.each(oChannels, function (i) {
								var id = parseInt(_Q(this).find("id").eq(0).text(), 10),
									name = _Q(this).find("name").eq(0).text();
								if ("" == name) {
									name = "Zero Channel " + (id < 9 ? "0" + id : id);
								}
								if ("true" == _Q(this).find("enabled").eq(0).text()) {// 过滤禁用的零通道
									oSel.append("<option value='" + id + "' bZero='true'>" + name + "</option>");
								}
							});
						},
						error: function () {
						}
					});
					channelChange();
				},
				error: function () {
					console.log("登录失败...");
				}
			 });
			 if (-1 == iRet) {
				 alert('已获取到');
				console.log("已登录过...");
			 }
	}
}
function changeVideoType(obj){
    if(obj.value==301||obj.value=='301'){
    	_Q('li[name=hk]').show();
    	if(_Q('#video_access_way').val()==1){
    		_Q('li[name=new_hk]').hide();
    		_Q('li[name=new_sp]').hide();
    		_Q('#getOn').hide();
	    }else{
	    	_Q('li[name=new_hk]').show();
	    	_Q('li[name=new_sp]').show();
	    	_Q('#getOn').show();
		}
    	_Q('li[name=new_fw]').show();
    	_Q('li[name=sp]').hide();
    	_Q('#help').show();
    	_Q('#help').attr("href","#{request.contextPath}/help/hkVideoHelp.seam"); 
    }else if(obj.value==303||obj.value=='303'){
    	_Q('li[name=hk]').hide();
    	_Q('li[name=new_hk]').hide();
    	_Q('li[name=sp]').hide();
    	_Q('li[name=new_sp]').show();
    	_Q('li[name=new_fw]').hide();
    	_Q('#help').hide();
    	_Q('#video_app_device_video_channel_no').val("");
    }else if(obj.value==304||obj.value=='304'){
    	_Q('li[name=hk]').hide();
    	_Q('li[name=new_hk]').hide();
    	_Q('li[name=sp]').hide();
    	_Q('li[name=new_sp]').show();
    	_Q('li[name=new_fw]').hide();
    	_Q('#help').hide();
    	_Q('#video_app_device_video_channel_no').val("");
    }else if(obj.value==305||obj.value=='305'){
    	_Q('li[name=hk]').hide();
    	_Q('li[name=new_hk]').show();
    	_Q('li[name=new_sp]').show();
    	_Q('li[name=sp]').show();
    	_Q('li[name=new_fw]').show();
    	_Q('#help').show();
    	_Q('#help').attr("href","#{request.contextPath}/help/spVideoHelp.seam"); 
    	_Q('#video_app_device_video_channel_no').val("");
    }
}
function changeHtml(obj){
	  if(_Q('#video_access_way').val()==1){
		  _Q('li[name=new_hk]').hide();
		  _Q('li[name=new_sp]').hide();
		  _Q('#getOn').hide();
	    }else{
	    	_Q('li[name=new_hk]').show();
	    	_Q('li[name=new_sp]').show();
	    	_Q('#getOn').show();
		}
}
function checkSubmit(){
	var name = _Q('#video_name').val();
	if(name==null||name==''){
		alert('设备名称不能为空');
		return false;
	}
	if(name.length>30){
		alert('名称过长不能超过45个字符！');
		return false;
	}
	var typeId = _Q('#video_type_id').val();
	var accessWay = _Q('#video_access_way').val();
	var appIp = _Q('#video_app_ip').val();
	var appWebPort = _Q('#video_app_web_port').val();
	var devicePort = _Q('#video_device_port').val();
	var appPort = _Q('#video_app_port').val();
	var appUsername = _Q('#video_app_username').val();
	var appPassword = _Q('#video_app_password').val();
	var channelNo = _Q('#video_app_device_video_channel_no').val();
	var sn = _Q('#video_sn').val();
	var baseId = _Q('#video_base_id').val();
	var coordinateX = _Q('#video_coordinateX').val();
	var coordinateY = _Q('#video_coordinateY').val();
	var partitionId = _Q('#video_partition_id').val();
	var tunnelId = _Q('#video_tunnel_id').val();
	var id = _Q('#video_id').val();
	//var ip= /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
	var ip=/^[a-zA-Z0-9\.]*$/;
	var reg = /^[1-9]+[0-9]*]*$/; 

	if(appIp!='' && !ip.test(appIp)){
		alert('IP/域名输入不正确');
		return false;
	}
	if(appWebPort!='' && !reg.test(appWebPort)){
		alert('HTTP端口输入不正确');
		return false;
	}
	if(devicePort!='' && !reg.test(devicePort)){
		alert('RTSP端口输入不正确');
		return false;
	}
	if(appPort!='' && !reg.test(appPort)){
		alert('服务端口输入不正确');
		return false;
	}
	
	saveVideo(id,name,typeId,accessWay,appIp,appWebPort,devicePort,appPort,appUsername,appPassword,channelNo,sn,baseId,coordinateX,coordinateY,partitionId,tunnelId);
	return true;
}

function checkSubmit2(){
	var typeId = _Q('#video_type_id').val();
	if(typeId==305){
		var sn = _Q('#video_sn').val();
		var id = _Q('#video_id').val();
		videoSnChick(id,sn);
		return true;
	}else{
		checkSubmit();
	}
}
function videoDelete(){
	var id = _Q('#video_id').val();
	deleteVideo(id);
}

function channelChange(){
	var channels = _Q('#channels').val();
	_Q('#video_app_device_video_channel_no').val(channels);
}

function huidiao2(data){
	if(data!=null && data!=''){
		alert(data);
	}else{
		checkSubmit();
	}
}

function huidiao(data){
	//if(data == "no1"){
	//	alert("设备数量超出上限!");
	//	return
	//}
	//if(data == "no2"){
	//	alert("保存失败请重试!");
	//	return;
	//}
	window.parent.window.video_ok(data);
}
function deleteNext(data){
	var id = _Q("#video_id").val();
	window.parent.window.iframeDeleteVideo(id);
}
//]]>
</script>

<script type="text/javascript" src="#{request.contextPath}/asset/monitoring/js/webVideoCtrl.js"/>
</ui:composition>                        
                                
