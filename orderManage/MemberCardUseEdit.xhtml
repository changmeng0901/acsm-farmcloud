<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    template="/layout/empty_template.xhtml">

	<ui:define name="body">
	<link type="text/css" rel="stylesheet" href="css/style.css"/>
	<link type="text/css" rel="stylesheet" href="css/bootstrap3.min.css" />
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap-datetimepicker.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/new/bootstrap-datetimepicker.zh-CN.js"></script>
	
#{memberInfoView.cardModifyInit()}
	<style>
		.bootSelt105{margin-right:10px;}
		.bootSelt105 .btn-group .btn{height:30px;}
		.bootSelt105 .bootstrap-select:not([class*="span"]):not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn){width:105px; margin-right:0;}
		.bootSelt105 .bootstrap-select{width:105px; margin-right:0;}
		.inline{display: inline-block;}
		.editor td{padding: 10px 0;}
		.mr10{margin-right: 10px;}
		.pl5{padding-left: 5px;}
		.former{width: 120px; text-align: right;}
		.former .bootstrap-select:not([class*=span]):not([class*=col-]):not([class*=form-control]):not(.input-group-btn) {
    	width: 110px; margin-right: 5px; margin-bottom: 0;}
    	.former .bootstrap-select{width: 110px; margin-right: 5px; margin-bottom: 0;}
    	
		.tableModel{ border-left:1px solid #e1e1e1; border-right:1px solid #e1e1e1; border-top:1px solid #e1e1e1; border-radius:10px 10px 0 0; border-collapse:separate; font-family:'微软雅黑'; color:#6c6a6b;}
		.tableModel thead{ border-radius:10px 10px 0 0;}
		.tableModel thead th ,.tableModel tbody td{ height:38px; text-align:center; border-bottom:1px solid #e1e1e1;}
		.tableModel thead th{ height:42px; background:#f0f5fb; font-size:14px; font-weight:normal;}
		.tableModel thead th:first-child{ border-radius:10px 0 0 0;}
		.tableModel thead th:last-child{ border-radius:0 10px 0 0;}
		.tableModel tbody tr td{ font-size:13px; background:#fcfcfc;}
		.tableModel tbody tr.odd td{ background:#fbfcfe;}
		.tableModel tbody tr.hover td{ background:#ecf7e6;}
		.tableModel .icheckbox_minimal-blue, .tableModel .icheckbox_minimal-blue.checked{ display:inline-block; float:none; margin:0;}
		.tableModel .iradio_minimal-blue, .tableModel .iradio_minimal-blue.checked{ display:inline-block; float:none; margin:0;}
		.zt_a2,.zt_a1,.zt_a3,.zt_a4,.zt_a5,.zt_a6,.zt_a7,.zt_a8,.zt_a9,.zt_a10,.zt_a11,.zt_a12,.zt_a13,.zt_a14,.zt_a15{line-height:22px; font-size:12px; display:inline-block; padding-left:3px;}
		.zt_a2 strong,.zt_a1 strong,.zt_a3 strong,.zt_a4 strong,.zt_a5 strong,.zt_a6 strong,.zt_a7 strong,.zt_a8 strong,.zt_a9 strong,.zt_a10 strong,.zt_a11 strong,.zt_a12 strong,.zt_a13 strong,.zt_a14 strong,.zt_a15 strong{ line-height:22px; display:inline-block; padding:0 10px 0 7px; font-weight:normal; margin-right:-3px; color:#6c6a6b;}
    	.pageModel {margin: 40px auto 0; border: 1px solid #e1e1e1; border-radius: 5px; border-collapse: separate; font-size: 12px;}
		.pageModel span {float: left;height: 32px;line-height: 32px;border-right: 1px solid #e1e1e1;}
		.pageModel a {display: block;padding: 0 13px;color: #9a9a9a;text-decoration: none;}
		.pageModel a:hover{color:#428bca;}
		.pageModel span:last-child { border-right: 0; }
		.pageModel .page_Cur{background-color: #f6f6f8}
	</style>
	<td valign="top">
		<h:form id="cardInfo" enctype="multipart/form-data">
			<div aria-hidden="false" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade in w600na" style="display: none;">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
							<h4 class="modal-title" id="myModalLabel">提示框</h4>
						</div>
						<div class="modal-body">
							<span id="productMsg">*号部分为必填项！</span>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							<button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
						</div>
					</div>
				</div>
			</div>
			<div class="right_c">
				<div class="r_title">
					<div class="r_t_l">采销存<span style="padding:0 5px;">&gt;</span>订单管理<span style="padding:0 5px;">&gt;</span><font size="3">会员卡管理</font></div>
					<div class="fr" style="margin-bottom:-1px;">
						<ul class="cm_resumeList clear">
							<li>
								<a href="#{request.contextPath}/orderManage/OrderOperateList.seam"><img src="../asset/images/orderManage/resumeIco50.jpg" /><span>订单管理</span></a>
							</li>
							<li>
								<a class="borderBt" href="#{request.contextPath}/order/MemberInfoListOne.seam"><img src="../asset/images/orderManage/resumeIco51.jpg" /><span>客户管理</span></a>
							</li>
							<li>
								<a  href="#{request.contextPath}/card/CardInfoList.seam?cardType=0"><img src="../asset/images/orderManage/resumeIco51.jpg" /><span>会员卡管理</span></a>
							</li>
						</ul>
					</div>
				</div>
				<div  class="all_d3" style="width:860px; margin:50px auto 0;">
					<table width="100%" cellpadding="0" cellspacing="0" class="editor">
						<tr>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">卡编号：</td>
										<td>#{memberInfoView.memberCard.cardsInfo.cardCode}</td>
									</tr>
								</table>
							</td>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">卡种类：</td>
										<td>礼品卡</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">卡类型：</td>
										<td>#{memberInfoView.memberCard.cardsInfo.cardCategory.name}</td>
									</tr>
								</table>
							</td>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">卡状态：</td>
										<td>#{memberInfoView.cardStatus}</td>
									</tr>
								</table>
							</td>
							
						</tr>
						<tr>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">剩余配送次数：</td>
										<td id="deNum">#{memberInfoView.memberCard.deliverNum+memberInfoView.memberCard.cardsInfo.deliverChangeNum}</td>
									</tr>
								</table>
							</td>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">
											<select class="selectpicker" id="deliverSelect" name="deliverSelect">
											    <option value="0">增加配送次数</option>
												<option value="1">减少配送次数</option>
											</select>
										</td>
										<td>
											<input id="deliverNum"  name="deliverNum" class="form-control inline" style="width:150px;" onkeyup="clearNoNum(this, event);"/>次
										</td>
									</tr>
								</table>
								
							</td>
						</tr>
						<tr>
							<td width="50%">
								<s:div id="getTime">
								<table width="100%">
									<tr>
										<td class="former">截止有效期：</td>
										<td id="expiryStr">#{memberInfoView.memberCard.expiryStr}</td>
									</tr>
								</table>
								</s:div>
							</td>
							<td width="50%">
								<table width="100%">
									<tr>
										<td class="former">
											延长有效期：
										</td>
										<td>
											<div class="input-append date form_datetime " style="width:170px;position:relative;">
				                            <h:inputText size="26" id="pickTimeId"  style="width:170px;" readonly="true" value="" onchange="changeTime();">
										    <f:convertDateTime pattern="yyyy-MM-dd hh:mm:ss"/>   
										    </h:inputText>
										    <span class="add-on" style="position:absolute;right:5px;top:7px;"><i class="icon-th" style="margin:0;"></i></span>
										    <h:inputHidden id="endTime" name="endTime" value="#{memberInfoView.memberCard.cardsInfo.endTime}"/>
										    <input type="hidden" name="endTime2" id="endTime2" value=""/>
				                            </div>
										</td>
									</tr>
								</table>	
							</td>
							<!-- <td width="50%">
								<table width="100%">
									<tr>
										<td class="former">
											<select class="selectpicker expiry" name="expirySelect">
												<option value="0">延长有效期</option>
												<option value="1">缩短有效期</option>
											</select>
										</td>
										<td>
											<input id="expiryNum" class="form-control inline" style="width:150px;" name="expiryNum" onkeyup="clearNoNum(this, event);"/>月
										</td>
									</tr>
								</table>	
							</td> -->
						</tr>
					</table>
					
					<div class="footBox">
						<div style="font-size: 18px; margin-bottom: 15px;font-weight: bold;"> 修改记录 </div>
						<div class="tab-content qiehuan">
							<div class="tab-pane active mh15" id="order_div">
								<s:div id="cardUpdateMess">
									<table class="tableModel thead" width="100%" cellpadding="0" cellspacing="0">
										<thead>
											<tr>
												<th style="width:15%">序号</th>
												<th style="width:25%">修改日期</th>
												<th style="width:35%">修改内容</th>
												<th style="width:25%">修改人</th>
											</tr>
										</thead>
										<tbody>
											<a:repeat value="#{memberInfoView.cardUpdateMessages}" var="_updateMess" rowKeyVar="_index">
												<tr>
													<td style="width:15%">#{_index + 1}</td>
													<td style="width:15%">
														<h:outputText value="#{_updateMess.updateTime}">
									        				<s:convertDateTime type="both" dateStyle="short" pattern="yyyy-MM-dd HH:mm" />
									        			</h:outputText>
													</td>
													<td style="width:10%">#{_updateMess.updateDescribe}</td>
													<td style="width:10%">#{_updateMess.updateUserName}</td>
												</tr>
											</a:repeat>
										</tbody>
									</table>
									
									<table class="pageModel" >
										<tbody>
											<tr>
												<td>
													<s:span rendered="#{memberInfoView.card_update_max_page > 1}">
														<a href="javascript:void(0);" class="page_prev" onclick="operatePageAction(1);">首页</a>
													</s:span>
													<s:span styleClass="pagePrve" rendered="#{memberInfoView.card_update_page - 1 gt 0 and memberInfoView.card_update_max_page gt 1}">
														<a href="javascript:void(0);" onclick="operatePageAction(#{memberInfoView.card_update_page - 1});">&lt;&lt;</a>
													</s:span>
													<a:repeat value="#{memberInfoView.card_update_show_page_list}" var="_da_page" rowKeyVar="_da_index">
														<span class="page_num #{_da_page == memberInfoView.card_update_page ? 'page_Cur' : ''}">
															<a href="javascript:void(0);" onclick="operatePageAction(#{_da_page});">#{_da_page}</a>
														</span>
													</a:repeat>
													<s:span styleClass="page_next" rendered="#{memberInfoView.card_update_page + 1 lt memberInfoView.card_update_max_page and memberInfoView.card_update_max_page gt 1}">
														<a href="javascript:void(0);" onclick="operatePageAction(#{memberInfoView.card_update_page + 1});">&gt;&gt;</a>
													</s:span>
													<s:span rendered="#{memberInfoView.card_update_max_page gt 1}">
														<a href="javascript:void(0);" onclick="operatePageAction(#{memberInfoView.card_update_max_page});">尾页</a>
													</s:span>
													<span >
														<span class="pageCount" style="border-right:0"><a>共#{memberInfoView.card_update_max_page}页</a></span>
													</span>
												</td>
											</tr>
										</tbody>
									</table>
								</s:div>
							</div>
						</div>
					</div>
					
					<div style="padding:40px 0; text-align:center;">
					    <h:commandButton id="saveBtn" action="#{memberInfoView.updateCardInfo()}"  style="display:none"/>
						<input type="button"  class="btn btn-primary mr10" value="保存" onclick="validate();"/>
						<s:link view="/orderManage/MemberInfoView.xhtml" styleClass="btn btn-default" value="返回" propagation="end">
							<f:param name="memberInfoId" value="#{memberInfoView.memberInfoId}"></f:param>
							<f:param name="pageNum" value="#{memberInfoView.pageNum}"></f:param>
						</s:link>
					</div>
				</div>
			</div>
		</h:form>
		
		<div aria-hidden="false" id="messageDiv" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" class="modal fade in w600na">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true"></span><span class="sr-only">Close</span></button>
						<h4 class="modal-title" id="messageTitle">提示</h4>
					</div>
					<div class="modal-body">
						<span id="messageValue"></span>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
					</div>
				</div>
			</div>
		</div>
	</td> 
	<a:form>
  		<a:queue requestDelay="10" ignoreDupResponses="true"/>
  		<a:jsFunction name="compare" action="#{memberInfoView.compareTo()}" data="#{memberInfoView.compareNum}" oncomplete="comp(data);">
  			<a:actionparam name="exparyDateNum" value="#{memberInfoView.exparyDateNum}" />
  		</a:jsFunction>
  		<a:jsFunction name="operatePageFind" action="#{memberInfoView.updateCardMess()}" reRender="cardUpdateMess">
			<a:actionparam name="card_update_page" assignTo="#{memberInfoView.card_update_page}"/>
		</a:jsFunction>
	</a:form>
	<script type="text/javascript">
	//<![CDATA[
		function comp(data){
			if(Number(data)<0){
				jQuery("#messageValue").html("缩短有效期输入错误，请重新输入！");
                jQuery("#messageDiv").modal('show');
                return false;
			}else{
				jQuery("#cardInfo\\:saveBtn").click();
			}
		}
		//保存验证
		function validate(){
			var deliverNum=jQuery("#deliverNum").val();
			var expiryNum=jQuery("#expiryNum").val();
			var reg=/^[1-9][\d]{0,9}$/;
			if(deliverNum!=""){
				if(reg.test(deliverNum)){
					var deliverSelect=jQuery("#deliverSelect").val();
					if(deliverSelect==1){
						var deNum=jQuery("#deNum").text();
						if(Number(deliverNum)>Number(deNum)){
							jQuery("#messageValue").html("减少配送次数不能大于剩余配送次数，请重新添加后再次保存。");
			                 jQuery("#messageDiv").modal('show');
			                 return false;
						}
					}
				}else{
					 jQuery("#messageValue").html("添加配送次数格式或长度错误！");
	                 jQuery("#messageDiv").modal('show');
	                 return false;
				}
			}
			if(expiryNum!=""){
				/* var expirySelect=jQuery(".expiry").val();
				if(expirySelect==1){
					compare(expiryNum);
				}else{ */
					jQuery("#cardInfo\\:saveBtn").click();
				/* } */
				
			}else{
				jQuery("#cardInfo\\:saveBtn").click();
			}
			
		}
		//验证输入值
		function clearNoNum(obj, event){
			var keyCode = event.keyCode;
			var val=obj.value;
			if (keyCode < 37 || keyCode > 40) {
				if(!(keyCode >=48 && keyCode <=57)){
					obj.value = obj.value.replace(/[^\d]/g,"");  //清除“数字”和“.”以外的字符  
				}
			}
			
		}
		jQuery(document).ready(function(){
			var exVal='#{memberInfoView.exNum}';
			if(Number(exVal)<30){
				var str="<option value='0'>延长有效期</option>";
				jQuery(".expiry").empty().append(str);
			}
			jQuery('.selectpicker').selectpicker();  // 下拉框控件
		});
		jQuery(".form_datetime").datetimepicker({
		    format: "yyyy-mm-dd",
		    autoclose: true,
			weekStart: 1,
			language:  'zh-CN',
			minView:2,
			startDate: formatDate(new Date(),'yyyy-MM-dd'),
		    pickerPosition: "bottom-left"
		 });

		function changeTime(){
			var time = jQuery("#cardInfo\\:pickTimeId").val();
			jQuery("#expiryStr").html(time);
			jQuery("#cardInfo\\:endTime").val(time);
			jQuery("#endTime2").val(time);
		}


		//格式化时间
		Date.prototype.format = function(format){ 
		var o = { 
		"M+" : this.getMonth()+1, //month 
		"d+" : this.getDate(), //day 
		"h+" : this.getHours(), //hour 
		"m+" : this.getMinutes(), //minute 
		"s+" : this.getSeconds(), //second 
		"q+" : Math.floor((this.getMonth()+3)/3), //quarter 
		"S" : this.getMilliseconds() //millisecond 
		} 
		if(/(y+)/.test(format)) { 
		format = format.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
		} 
		for(var k in o) { 
		if(new RegExp("("+ k +")").test(format)) { 
		format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length)); 
		} 
		} 
		return format; 
		} 
		function formatDate(date,format){ 
		        var paddNum = function(num){ 
		          num += ""; 
		          return num.replace(/^(\d)$/,"0$1"); 
		        } 
		        //指定格式字符 
		        var cfg = { 
		           yyyy : date.getFullYear() //年 : 4位 
		          ,yy : date.getFullYear().toString().substring(2)//年 : 2位 
		          ,M  : date.getMonth() + 1  //月 : 如果1位的时候不补0 
		          ,MM : paddNum(date.getMonth() + 1) //月 : 如果1位的时候补0 
		          ,d  : date.getDate()   //日 : 如果1位的时候不补0 
		          ,dd : paddNum(date.getDate())//日 : 如果1位的时候补0 
		          ,hh : date.getHours()  //时 
		          ,mm : date.getMinutes() //分 
		          ,ss : date.getSeconds() //秒 
		        } 
		        format || (format = "yyyy-MM-dd hh:mm:ss"); 
		        return format.replace(/([a-z])(\1)*/ig,function(m){return cfg[m];}); 
		} 

		//分页
		function operatePageAction(page){
			operatePageFind(Number(page));
		}
	//格式化时间结束
	//]]>
	</script>
	<script type="text/javascript">
			
			  window.onload = function () {
				  jQuery('.selectpicker').selectpicker();
			  };
			</script>
	</ui:define>
</ui:composition>
