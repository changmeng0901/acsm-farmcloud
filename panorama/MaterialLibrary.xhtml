<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j"
    template="/layout/template_new.xhtml">

<ui:define name="body">	
 	<link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/commons/commons.css" />
    <link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/skinBlue.css" />
    <link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/panorama/MaterialLibrary.css" />
    
    <script type="text/javascript" src="#{request.contextPath}/asset/js/aerialphoto/MaterialLibrary.js"></script>

<style>
	.box_back{background:url(../asset/images/bg_png3.png) repeat; width:100%; height:100%;position:absolute; z-index:101; display:none;}
	#container{position:relative;float:right;width:88px;height:34px;overflow:hidden;}
	#container .moxie-shim { position:absolute-;right:0;top:0--;}
	#container:hover .moxie-shim input{ cursor:pointer; }
</style>
	#{panoramaHome.searchKrpanosList()}
	<div style="background:url(../asset/images/stock/commons/opacity_b30.png) repeat; width:100%; height:100%; position:absolute; z-index:1684; display:none;" id="krpLogin"></div>
	<div style="background:url(../asset/images/growth/zwleft_04.png) repeat; width:100%; height:100%; position:absolute; z-index:1684; display:none;" id="login1"></div>
	<div style="background:url(../asset/images/bg_png.png) repeat; width:100%; height:100%; position:absolute; z-index:1684; display:none;" id="videoLogin">
		<div id="login2" style="width:60px; height:60px; margin:220px auto 0 auto;"><img src="../asset/images/loginda.gif" /></div>
		<div id="ossfile" style="margin-top:20px;"></div> 
	</div>
	<div class="box_back" id="krpanoLogin" style="display:none">
    	<div id="login2" style="width:250px; height:60px; margin:220px auto 0 auto;text-align:center">
    		<img src="../asset/images/loginda.gif" style="width:128px;"/>
    		<p id="fileTips" style="display:none;height:20px;line-height:20px; text-align:center;color: white;width: 250px;font-size: 16px;">正在转换四季田景，请耐心等待！</p>
  		</div>
	</div>
        	<td valign="top">
            <div class="material_main">
                <!-- 素材库右侧 -->
                <div class="material_content pl30 pr30">
                    <div class="breadNav_wap clear">
                        <div class="breadNav_lt"><a href="#">精准营销</a><span>&gt;</span><strong>四季田景</strong></div>
                        <div class="breadNav_rt" style="margin-bottom:-1px; margin-top:1px;">
                            <ul class="resumeList clear">
                                <li>
                                    <a href="PanoramaEdit.seam"><img src="#{request.contextPath}/asset/images/panorama/panorama_icon1.png"/><span>四季田景列表</span></a>
                                </li>
                                <li class="cur">
                                    <a href="MaterialLibrary.seam"><img src="#{request.contextPath}/asset/images/panorama/panorama_icon2.png" /><span>素材库</span></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                   
                    <div class="panorama_material mt20 mb20">
                    	<div class="panorama_material_header clear">
                        	<s:div id="krpanosListSize"><p class="text_title fl">已有全景素材<span>#{panoramaHome.krpanosList.size()}</span>个</p></s:div>
                        	<div id="container">
	                            <button type="button" class="btn btn-primary fr" id="selectfiles" style="cursor: pointer;">上传全景</button>	                            
							</div>
							<div id="ossfile1"></div>
							<a style="display: none" id="postfiles1" href="javascript:void(0);" class='btn' onclick="apply(18);"></a>
							<a style="display: none" id="callback" href="javascript:void(0);" class='btn' onclick="callback();"></a>
							<input type="hidden" value="" id="krpanoFileUrl" />
                        </div>
                        <s:div id="krpanosList">
                        <div class="panorama_material_body"></div>
                    	<!-- 无数据 -->
                    	<s:fragment rendered="#{empty panoramaHome.krpanosList}">
	                        <div class="material_nodata">
	                            <p class="nodata_text">
	                            	<img src="#{request.contextPath}/asset/images/panorama/MaterialLibrary_pic1.png" /><br/>
	                                	您还未上传全景图！
	                            </p>
	                        </div>
                        </s:fragment>
                        <!-- 有数据 -->
                        <s:fragment rendered="#{not empty panoramaHome.krpanosList}">
	                        <div class="material_data">
	                        	<ul class="material_list clear">
	                        	<a4j:repeat value="#{panoramaHome.krpanosList}" var="_krp">
	                            	<li class="m_item">
	                                	<div class="panorama_li">
	                                    	<div class="pano_pos">
	                                        	<div class="icon_block">
	                                            	<p class="icon_view">
	                                                    <span onclick="preview(this,'#{_krp.id}','#{_krp.baseId}','#{_krp.enterpriseInfoId}')">
	                                                        <img src="#{request.contextPath}/asset/images/panorama/MaterialLibrary_icon2.png" />预览
	                                                    </span>
	                                                </p>
	                                                <p class="icon_name">
	                                                    <span onclick="oRename(this,'.text_name','.text_ipt')">
	                                                        <img src="#{request.contextPath}/asset/images/panorama/MaterialLibrary_icon3.png" />重命名
	                                                    </span>
	                                                </p>
	                                                <p class="icon_delt">
	                                                    <span onclick="deleteItem('#{_krp.id}')">
	                                                        <img src="#{request.contextPath}/asset/images/panorama/MaterialLibrary_icon4.png" />删除
	                                                    </span>
	                                                </p>
	                                            </div>
	                                        </div>
	                                    	<p class="pano_hd">
	                                        	<img src="#{_krp.filefold}/mobile_f.jpg@300w_174h_1e_1c.jpg" />
	                                        </p>
	                                        <div class="pano_bd">
	                                        	<i class="icon_qj" title="全景定位" onclick="show_krpanos_map('#{_krp.id}','#{panoramaHome.baseId}','#{panoramaHome.coordinate_X}','#{panoramaHome.coordinate_Y}')"></i>
	                                            <p class="text_name" title="#{_krp.name}">#{_krp.name}</p>
	                                            <input type="text" class="text_ipt" value="" onblur="saveKrpanosName('#{_krp.id}',this)"/>
	                                        </div>
	                                    </div>
	                                </li>  
	                                </a4j:repeat>                                  
	                            </ul>
	                        </div>
	                     </s:fragment>
                        <!-- 有数据 -->
                        </s:div>
                    </div>
                   
                </div>
                <!-- 素材库右侧 -->
            </div>   
            <!-- 全景预览 -->
			<iframe src="" aa="#{request.contextPath}/map/Krpano.seam" id="krpano_iframe" frameborder="no" border="0" style="display:none;width:600px;height:600px;">       
		    </iframe>	   
		    <div id="krpano_iframe_img" style="display:none">
		    	<img src="#{request.contextPath}/asset/krpano/skin/closeImg.png" onclick="closeKrpanoFrame()" style="width:40px;heigh:40px;cursor:pointer;" />
		    </div>
		     <!-- 全景定位-->
		     <div id="krpano_map_div" style="display:none;">
				<iframe src="" id="krpano_map_iframe" frameborder="no" border="0" style="width:600px;height:600px;border: 8px solid;border-color: #aab4c0;border-radius: 15px;background:#aab4c0;">       
				</iframe>
		    	<h:form name="krpanosForm" id="krpanosForm">
	 			<div style="text-align:center;margin-top:15px;">             	        	
	             	<h:commandButton styleClass="btn btn-primary" value="保存" onclick="if(!editKrpanoInfo()){return false;}" action="#{panoramaHome.editKrpanoInfo()}"/>
	             	<a class="btn btn-default" style="margin-left:5px;" href="#" onclick="closeKrpanosMap();">取消</a>			        
	            </div>	            
	            	<h:inputHidden type="text" id="krpano_id" value="#{panoramaHome.krpanosId}"/>   
			        <h:inputHidden type="text" id="krpanos_base_id" value="#{panoramaHome.baseId}"/>
			        <h:inputHidden type="text" id="krpanos_coordinate_X" value="#{panoramaHome.coordinate_X}"/>
			        <h:inputHidden type="text" id="krpanos_coordinate_Y" value="#{panoramaHome.coordinate_Y}"/> 
	            </h:form>
            </div>		    
			<a4j:status id="ajaxStatus" forceId="true" onstart="jquery('#login').show()" onstop="jquery('#login').hide()" />
			<a4j:form id="formid" >
				<a4j:queue requestDelay="10" ignoreDupResponses="true" id="mainQueue"/>
				<a4j:jsFunction status="ajaxStatus" eventsQueue="mainQueue" name="delKrpanosCheck" action="#{panoramaHome.delKrpanosCheck()}" data="#{panoramaHome.message}" oncomplete="delCheckBack(data);" >
					<a4j:actionparam name="krpanosId" assignTo="#{panoramaHome.krpanosId}"/>
				</a4j:jsFunction>
				<a4j:jsFunction status="ajaxStatus" eventsQueue="mainQueue" name="delKrpanos" action="#{panoramaHome.delKrpanos()}" reRender="krpanosList,krpanosListSize" >
					<a4j:actionparam name="krpanosId" assignTo="#{panoramaHome.krpanosId}"/>
				</a4j:jsFunction>
				<a4j:jsFunction eventsQueue="mainQueue" name="renameKrpanos" action="#{panoramaHome.renameKrpanos()}" reRender="krpanosList,krpanosListSize" >
					<a4j:actionparam name="krpanosId" assignTo="#{panoramaHome.krpanosId}"/>
					<a4j:actionparam name="krpanosName" assignTo="#{panoramaHome.krpanosName}"/>
				</a4j:jsFunction>
				<a4j:jsFunction eventsQueue="mainQueue" name="saveKrpanoInfo" action="#{panoramaHome.saveKrpanoInfo()}" reRender="krpanosList,krpanosListSize" >
				</a4j:jsFunction>
			</a4j:form>
            </td>
      <script type="text/javascript" src="#{request.contextPath}/asset/js/jquery-1.2.6.pack.js"></script>  
      <script type="text/javascript">
		//<![CDATA[
           var oss_url = "#{dataDicConstant.getOssUrl()}";
           var bucket_type ="#{dataDicConstant.getBucketType()}";
           var domain_url = "#{dataDicConstant.getDomainNameUrl()}";
           var workpath = "#{request.contextPath}";
           //全景
           var filters1 = {
               mime_types : [ //允许上传图片和zip,rar文件以及视频文件
                              { title : "Image files", extensions : "jpg" }, 
                              ],
                              max_file_size : "20mb", //最大只能上传20mb的文件
                              prevent_duplicates : false ,//不允许选取重复文件
                              width_div_height :2
                          };

	   		
		//]]>
    </script>      
    
	<script type="text/javascript" src="#{request.contextPath}/asset/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
	<script type="text/javascript" src="#{request.contextPath}/asset/js/map/krpanoPicUpload.js"></script>
	<script>
	//<![CDATA[
		function apply(obj){
			jQuery("#krpanoLogin").show();
			jQuery("#fileTips").show();
			jQuery("html").css("overflow","hidden");
			var entId='#{sessionTake.getEnterpriseInfoId()}';
			set_upload_param(uploader1, '', false,obj,entId);
		}
        var uploaded_file_url = "";
       	var file_name = "";
       	var fileType =1;//全景
       	function callback() {   		
       		if(uploaded_file_url!=""){
       			jQuery.ajax({
       				type : "get",// 使用get方法访问后台
       				url : domain_url+"/util/cdServlet",// 要访问的后台地址
       				data : "type=changeKrpanosFile&fileType=" + fileType+"&imageUrl="+uploaded_file_url+"&fileName="+file_name,// 要发送的数据
       				dataType: "json",
       				success : function(msg) {
       					if(msg.result=="success"){
       						next();
       					}else if(msg.result == "continue"){
       						setTimeout(function(){next()},2000);
       					}
       				}
       			});
       		}
       	};

       	function next(){
       		jQuery.ajax({
       			type : "get",// 使用get方法访问后台
       			url : domain_url+"/util/cdServlet",// 要访问的后台地址
       			data : "type=KrpanosInfo&imageUrl="+uploaded_file_url,// 要发送的数据
       			dataType: "json",
       			success : function(msg) {
       				if(msg.result=="ok"){
       					setParentsValue()
       				}else if(msg.result == "continue"){
       					setTimeout(function(){next()},2000);
       				}
       			}
       		});
       	}
       	function setParentsValue() {
			saveKrpanoInfo();
			jQuery("#krpanoLogin").hide();
			jQuery("#fileTips").hide();
			jQuery("html").css("overflow","auto");
	    }
		//(6)点击重命名按钮点击事件
		function oRename(obj,oTxt,oInput){
			jQuery(obj).parents(".m_item").find( oTxt ).hide();
			jQuery(obj).parents(".m_item").find( oInput ).val(jQuery(obj).parents(".m_item").find( oTxt ).html());
			jQuery(obj).parents(".m_item").find( oInput ).show();
			jQuery(obj).parents(".m_item").find( oInput ).focus();
		}
		function saveKrpanosName(id,obj){
			var name=jQuery(obj).val();
			if(name==""){
				alert("全景名称不能为空");
				jQuery(obj).focus();
			}else{
				renameKrpanos(id,name);
			}
		}
		
		//删除全景
		var krpanosId;
		function deleteItem(id){
			krpanosId=id;
			delKrpanosCheck(id);
		}
		
		function delCheckBack(msg){
			if(msg!=""){
				if(confirm(msg)){
					delKrpanos(krpanosId);
					return true;
				}else{
					return false;   
				}	
			}else{
				if(confirm("确认删除吗？")){
					delKrpanos(krpanosId);
				}
			}
		}
		//预览
		function preview(obj,krpano_id,bid,enterid){
			 jquery("#krpano_iframe").attr("src",workpath+ "/map/Krpano.seam?type=3&krpano_id="+krpano_id+"&base_id="+bid+"&enterid="+enterid);
		    var height = document.body.clientHeight;
		    var width = document.body.clientWidth;
		    jquery("#krpano_iframe").css({"position":"fixed","z-index":1000});
	        var rightWidth =  jquery('#rightPane').width();
	        var self_width = width*0.75;
	        var self_height = height*0.75;
	        var of_top = (height-self_height)/2;
	        var of_left = (width-self_width)/2;
	        jquery("#krpano_iframe").css({"width":self_width,"height":self_height,"left":of_left,"top":of_top});
	        var div_left = width/2+self_width/2;
		    jquery("#krpano_iframe").show();
		    jquery("#krpano_iframe_img").show();
		    jquery("#krpano_iframe_img").css({"position":"fixed","z-index":1000,"left":div_left,"top":of_top});
		}
		function closeKrpanoFrame(){
			jquery("#krpano_iframe").hide();
			jquery("#krpano_iframe").attr("src","");
			jquery("#krpano_iframe_img").hide();
		}
		jquery(window).resize(function(){
			 resetFrameSize("krpano_iframe");
			 resetFrameSize("krpano_map_div");
		})
		function resetFrameSize(iframeId){
		    if(jquery("#"+iframeId).is(":visible")){
		        var height = document.body.clientHeight;
		        var width = document.body.clientWidth;
		        var rightWidth =  jquery('#rightPane').width();
		        jquery("#"+iframeId).css({"width":width,"height":height,left:0,top:0});
		        var self_width = width*0.75;
		        var self_height = height*0.75;
		        var of_top = (height-self_height)/2;
		        var of_left = (width-self_width)/2;
		        jquery("#"+iframeId).css({"width":self_width,"height":self_height,"left":of_left,"top":of_top});
		        var div_left = width/2+self_width/2;
		        jquery("#"+iframeId).show();
		        if(iframeId=="krpano_iframe"){
		        	jquery("#krpano_iframe_img").show();
				    jquery("#krpano_iframe_img").css({"position":"fixed","z-index":1700,"left":div_left,"top":of_top});
			    }else{
			    	jquery("#krpano_map_iframe").css({"width":self_width,"height":self_height});
				}			    
		    }
		}
		
        function show_krpanos_map(krpano_id,base_id,coordinate_X,coordinate_Y){
            jquery("#krpLogin").show();
        	jquery("#krpano_map_iframe").attr("src",workpath+ "/panorama/KrpanosMap.seam?krpanosId="+krpano_id);
		    var height = document.body.clientHeight;
		    var width = document.body.clientWidth;
		    jquery("#krpano_map_div").css({"position":"fixed","z-index":1700});
	        var self_width = width*0.75;
	        var self_height = height*0.75;
	        var of_top = (height-self_height)/2;
	        var of_left = (width-self_width)/2;
	        jquery("#krpano_map_div").css({"width":self_width,"height":self_height,"left":of_left,"top":of_top});
	        jquery("#krpano_map_iframe").css({"width":self_width,"height":self_height});
	        var div_left = width/2+self_width/2;
		    jquery("#krpano_map_div").show();
        }

		
		function closeKrpanosMap(){
			 jquery("#krpano_map_div").hide();
			 jquery("#krpLogin").hide();
		}
		function editKrpanoInfo(){
			var krpanoId=jquery("#krpano_map_iframe").contents().find('#krpano_id').val();	
			var krpBaseId=jquery("#krpano_map_iframe").contents().find('#krpanos_base_id').val();	
			var krpCoordinateX=jquery("#krpano_map_iframe").contents().find('#krpanos_coordinate_X').val();	
			var krpCoordinateY=jquery("#krpano_map_iframe").contents().find('#krpanos_coordinate_Y').val();	
			if(krpBaseId==""){
				alert("请将四季田景放到基地范围内!");
				return false;
			}
			jquery("#krpanosForm\\:krpano_id").val(krpanoId);
			jquery("#krpanosForm\\:krpanos_base_id").val(krpBaseId);
			jquery("#krpanosForm\\:krpanos_coordinate_X").val(krpCoordinateX);
			jquery("#krpanosForm\\:krpanos_coordinate_Y").val(krpCoordinateY);
			return true;
		}
		jquery('#container').hover(function(){
			jquery('#container .moxie-shim input').attr('style','font-size: 12px; opacity: 0; position: absolute; top: 0px; right: 0px; width: 200%; height: 100%;cursor: pointer;')
		});
		
	//]]>
	</script>

</ui:define>

</ui:composition>
