<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	template="/layout/template_new.xhtml">
	<ui:define name="body">
	<script type="text/javascript" src="#{request.contextPath}/asset/js/contract/superTables_compressed.js"></script>
	<link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/contract/superTables_compressed.css" />
	<style>
	/* 批量定价样式 */
	html{height:100%}
body{ overflow:hidden;}
.fakeContainer{padding: 0; border: none;width: 700px; /* Required to set */height: 400px; /* Required to set */overflow: hidden-; /* Required to set */}
.fakeContainer .total{ display:block; text-align:left; color:#429ad0;}
.sDefault-Fixed{ background:#fff;}
.sDefault th,.sDefault td{ padding:8px 15px;  text-align:center; border:none; }
.sDefault th{ height:34px; background:#9dd6a6; color:#fff; font-size:14px; font-family:'微软雅黑';}
.sDefault td{ height:30px; font-family:'微软雅黑'; font-size:14px; font-weight:normal; color:#737373; }
.sDefault th.borderTB{ border-top:1px solid #eee; border-bottom:1px solid #eee;}
.sDefault td.borderTB{ border-top:1px solid #eee; border-bottom:1px solid #eee;}
.sDefault th.borderLR{ border-left:1px solid #eee; border-right:1px solid #eee;}
.sDefault td.borderLR{ border-left:1px solid #eee; border-right:1px solid #eee;}
.sDefault th:first-child,.sDefault td:first-child{ border-left:1px solid #eee; border-right:1px solid #eee;}
.zuowuTime{ position:relative; z-index:10; width:115px; height:32px;}
.zuowuTime .zuowu{ position:absolute; bottom:0px; left:0;}
.zuowuTime .time{ position:absolute; top:0px; right:0;}
.zuowuTime .xianBg{ position:absolute; z-index:2; width:144px; height:46px; top:-8px; left:-15px;}
.zhezhaoWp{ float:left; width:29px; height:29px; position:relative; display:inline; margin-right:10px;}
.zhezhaoWp .zhezhao{ width:29px; height:29px; position:absolute; left:0; top:0; z-index:5;}
.zhezhaoWp .zhezhaoImg{ width:29px; height:29px; position:absolute; left:0; top:0; z-index:4;}
.zhezhaoTxt{ float:left; width:76px;overflow:hidden; line-height:29px; text-align:left; color:#429ad0; font-size:12px; font-family:'font-family:'微软雅黑';';}
.quekouAytjt_wap{ padding:20px 0;}
.sDefault .borderLt{ border-left:1px solid #eee;}
.sDefault .borderRt{ border-right:1px solid #eee;}
.sDefault .borderBt{ border-bottom:1px solid #eee;}
.sDefault .iptText50{ display:inline-block;}
.sDefault .iptText50 .form-control{ width:50px; height:24px; line-height:22px; padding:0; text-align:center; border-radius:0; font-size:14px;}
  
.batch_selectAll{ float:left; display:inline-block;}
.batch_selectAll .bootstrap-select{  width:146px;}
.batch_selectAll .bootstrap-select:not([class*="span"]):not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn){ width:146px;}
.batch_selectAll .bootstrap-select span{ font-size:14px; font-family:'微软雅黑';}
.batch_selectAll .bootstrap-select > .btn{ height:50px; border:0; border-radius:0; background:#9ed6a7;}
.batch_selectAll .bootstrap-select.btn-group .dropdown-menu{ max-width:146px;}/* 下拉框最大宽度控制 */
.batch_selectAll .bootstrap-select.btn-group:not(.input-group-btn), .bootstrap-select.btn-group[class*="span"]{ margin-right:0;}
.batch_selectAll .btn-group.open .dropdown-toggle{ box-shadow:0 0 0 rgba(0, 0, 0, 0.125) inset;}
.batch_selectAll .bootstrap-select .btn:focus{ outline-offset:0; outline:inherit !important;}
.batch_selectAll .bootstrap-select .btn:active{box-shadow:0 0 0 rgba(0, 0, 0, 0.125) inset;}
.batch_selectAll .bootstrap-select.btn-group .btn .filter-option{ text-align:center; font-weight:bold; color:#fff;}
.batch_selectAll .bootstrap-select .caret{ border-top-color:#fff; border-width:5px;}
.box_back{background:url(../asset/images/bg_png3.png) repeat; width:100%; height:100%; position:fixed; z-index:98; display:none;}
	</style>
       <td valign="top" >
<div class="box_back" id="login" style="z-index:1000">
    <div id="login2" style="width:60px; height:60px; margin:220px auto 0 auto;"><img src="../asset/images/loginda.gif" />
  	</div>
</div>
       <!-- #{retallPriceInfoHome.work()} -->
		<div class="right_c">
                	<!-- 公用头部 开始 -->
                	<div class="r_title clear">
                    	<div class="r_t_l fl">企业设置<span style="padding:0 5px;">&gt;</span>商品信息<span style="padding:0 5px;">&gt;</span><font size="3">批量定价</font></div>
                    </div>
					<!-- 公用头部 结束 -->
					<br/>
					
                    <h:form id="retallPriceForm">
                    <h:inputHidden value="#{retallPriceInfoHome.strJSON}" id="strJSON"/>
                    	 <!-- 排产内容 开始 -->
					<div class="clear">
                        <div class="quekouAytjt_wap pt10">
                            <div class="clear">
                            	<div class="fakeContainer" style="position:relative;">
                                <span class="batch_selectAll" style="position:absolute; left:0; top:0; z-index:9;">
                                    <select class="selectpicker" data-live-search="true" multiple="multiple" id="productCheck" onchange="changeProduct()">
	                                    <a4j:repeat value="#{retallPriceInfoHome.productAllList}" var="_product" rowKeyVar="_index">
	                                    	<option value="#{_product.productInfoId}">#{_product.name}</option>
	                                    </a4j:repeat>
                                    </select>
                                </span>
                                <h:panelGroup id="showPanel" style="margin:0; border:none; padding: 0;">
                                <table id="demoTable" style="margin-top: -23px; margin-left: -99px;" class=" sDefault sDefault-Main">
                                    <tbody>
                                        <tr>
                                            <th style="padding:0; border-right:1px solid #9dd6a6; border-left:1px solid #e1e1e1; background:none;"></th>
                                            <th>原价(元)</th>
                                            <a4j:repeat value="#{retallPriceInfoHome.typeList}" var="_type" rowKeyVar="_index">
	                                    		<th><h:outputText value="#{stringUtil.shortString(_type.name,10)}" title="#{_type.name}"/></th>
	                                   	    </a4j:repeat>
                                        </tr>
                                        <a4j:repeat value="#{retallPriceInfoHome.productList}" var="_product" rowKeyVar="_index">
	                                    		<tr class="tr_index aaa">
	                                    			<h:panelGroup rendered="#{_index eq 0}">
	                                    				<td align="left" title="#{_product.name}">
			                                            <span class="zhezhaoWp">
			                                            <img class="zhezhao" src="#{request.contextPath}/asset/images/zhezhao.png" width="29" height="29" />
			                                            <img class="zhezhaoImg" src="#{_product.productImage}" />
			                                            </span>
			                                            <span class="zhezhaoTxt">#{_product.name}</span>
			                                            </td>
			                                            <td class="borderRt">#{_product.productPrice}</td>
			                                            <h:outputText  value="#{_product.trhtml}" escape="false"/>
	                                    			</h:panelGroup>
	                                    			<h:panelGroup rendered="#{_index ne 0 and _index ne (retallPriceInfoHome.productList.size()-1)}">
	                                    				<td>
			                                            <span class="zhezhaoWp">
			                                            <img class="zhezhao" src="#{request.contextPath}/asset/images/zhezhao.png" width="29" height="29" />
			                                            <img class="zhezhaoImg" src="#{_product.productImage}" />
			                                            </span>
			                                            <span class="zhezhaoTxt">#{_product.name}</span>
			                                            </td>
			                                            <td class="borderRt">#{_product.productPrice}</td>
			                                            <h:outputText  value="#{_product.trhtml}" escape="false"/>
	                                    			</h:panelGroup>
	                                    			<h:panelGroup rendered="#{_index ne 0 and _index eq (retallPriceInfoHome.productList.size()-1)}">
	                                    				<td class="borderBt">
			                                            <span class="zhezhaoWp">
			                                            <img class="zhezhao" src="#{request.contextPath}/asset/images/zhezhao.png" width="29" height="29" />
			                                            <img class="zhezhaoImg" src="#{_product.productImage}" />
			                                            </span>
			                                            <span class="zhezhaoTxt">#{_product.name}</span>
			                                            </td>
			                                            <td class="borderBt borderRt">#{_product.productPrice}</td>
			                                            <h:outputText  value="#{_product.trhtml}" escape="false"/>
	                                    			</h:panelGroup>
                                        </tr>
	                                    </a4j:repeat>
                                        
                                    </tbody>
                                </table>
                                </h:panelGroup>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                        	<h:form id="productCountFrom" style="wid" >
                        	<input type="hidden" name="typeInfo" id="typeInfo" />
							<h:commandButton id="saveCount" styleClass="btn btn-primary"  action="#{retallPriceInfoHome.savePrice}" style="margin-right:10px;" value="保存" title="保存仅为保存在当前页，如需提交数据请点击确认完成。" onclick="if(!productCountclick()){return false;};jQuery('#login').show();" >
							</h:commandButton>
							<h:commandButton id="productCount" styleClass="btn btn-primary"  action="#{retallPriceInfoHome.savePrice}" style="margin-right:10px;" value="确认完成" onclick="jQuery('#login').show();saveInfo();" >
							</h:commandButton>
				    		<s:button view="/product/ProductInfoList.xhtml" styleClass="btn btn-default" value="返回" id="cancel" propagation="end" style="margin-right:10px;">
				    			<f:param name="pageNum" value="#{retallPriceInfoHome.pageNum}"/>
				    		</s:button>
				    	</h:form>
                        </div>
                        
                    </div>
                    <!-- 排产内容 结束 -->
					
                    </h:form>                         
                </div><!--right_c结束-->
                <a4j:form>
<a4j:queue requestDelay="100" ignoreDupResponses="true"/>
<a4j:jsFunction  name="changeProductMe" action="#{retallPriceInfoHome.changeProduct()}" reRender="showPanel"  oncomplete="refreshAction();" >
		<a4j:actionparam name="productStr" assignTo="#{retallPriceInfoHome.productStr}"/>
	</a4j:jsFunction>
</a4j:form> 
<script type="text/javascript">
//<![CDATA[
jQuery = jQuery.noConflict();
/* 表格控件 */
function createTable(){
	var oWindowWid = jQuery(window).width();
	var num = Math.round(oWindowWid/150);
	new superTable("demoTable", {
		cssSkin: "sDefault",
		headerRows : 1,
		fixedCols: 2,
		colWidths:arr
	});
}
function changeMe(){   // 计算表格宽高一屏显示
	var oCliHei = jQuery(window).outerHeight();
	var  tr_height_sum = 0;
	jQuery("div.sData #demoTable tr").each(function(){
		tr_height_sum += jQuery(this).height();
	});
	var height_c = 0;
	if(tr_height_sum < (oCliHei -220)){
		height_c = oCliHei -220 - tr_height_sum - 16;
	}
	var oCliWidth = jQuery(window).outerWidth();
	var oFakeContainerWid = oCliWidth -140;
	var oFakeContainerHei = oCliHei -220-height_c;	
	
	jQuery('.fakeContainer').css({
		width : oFakeContainerWid + 1 ,
		height : oFakeContainerHei	
	});
	jQuery('.sFHeader .sDefault-FixedHeaders').css({
		width : oFakeContainerWid		
	});
	jQuery('.sHeader').css({
		width : oFakeContainerWid + 1		
	});
	jQuery('.sHeaderInner').css({
		width : oFakeContainerWid		
	});
	jQuery('.sFData').css({
		width : oFakeContainerWid
	});
	jQuery('.sFHeader').css('width',252);
	jQuery('.sData').css({
		'width' : oFakeContainerWid-252,
		'height' :  oFakeContainerHei - 50,
		'margin-left' : 252,	
	});
	jQuery('.sData .sDefault-Main').css({
		'width' : oFakeContainerWid+146,
		'margin-left' : -252	
	});
	jQuery('.sData .sDefault-Main colgroup').css({
		'width' : oFakeContainerWid,
		'margin-left' : -252	
	});
}
function changColor(){  // 隔行换色 
	jQuery('.sFDataInner tbody tr:even').css('background','#fafafa');	
	jQuery('.sData tbody tr:even').css('background','#fafafa');
}
var productInitStr = "#{retallPriceInfoHome.productInitStr}";
jQuery(function(){
	
	jQuery('.selectpicker').selectpicker();  // 下拉菜单控件
	function noSelectedTOall(){
		jQuery(".filter-option").each(function(){  //如果下拉菜单为无可选项目，默认设置为全部商品
			if(jQuery(this).text() == "Nothing selected"){
				jQuery(this).text('全部商品');
			}
		});
	} ;
	createTable();
	noSelectedTOall();
	changeMe();
	changColor();
		
	jQuery(window).resize(function(){  // 改变浏览器窗口 
		createTable();
		changeMe();	
		changColor();
	});	
	if(productInitStr != ""){
		var checkStr= new Array(); //定义一数组
		checkStr = productInitStr.split(",");
		if(jquery("#productCheck option").length!=checkStr.length){
				jquery("#productCheck").selectpicker('val',checkStr);

			}
	}
});	

function changeProduct(){
	if(productInitStr == ""){
		jquery("#login").show();
		var str = jquery("#productCheck").val();
		if(str == null){
			str = "";
		}else{
			str = str.toString();
		}
		changeProductMe(str);
	}
	productInitStr = "";
}

//刷新
function refreshAction(){
	jquery("#login").hide();
	createTable();
	changeMe();	
	changColor();
	/* 下拉框 */
	jquery('.selectpicker').selectpicker();
}

var typeLen = "#{retallPriceInfoHome.typeList.size()}";
 var len = Number(typeLen)+2;
var arr = new Array();
for (var i = 0; i < len; i++) {
	if(i == 0){
		arr[i] = 146;
	}else if(i == 1){
		arr[i] = 106;
	}else{
		arr[i] = 150;
	}
	
}

function saveJSON(){
	var json = "{strjson:[";
	jquery(".sData .tr_index").each(function(trindex){
		json += "{'trindex':"+trindex+",";
		json += "'contract':[";
		var tdLen = jquery(".sData .td_index_"+trindex).length;
		tdLen = tdLen - 1;
		jquery(".sData .td_index_"+trindex).each(function(indexc){
			if(tdLen == indexc){
				//每一行的最后一个input值
				var val = jquery(".sData #input_final_"+trindex).val();
				if(val == ""){
					val = 0;
				}
				var finalVal = parseFloat(val);
				json += "{'typeid':"+indexc+",";
				json += "'inputval':"+finalVal+",";
				json += "},";
			}else{
				var val = jquery(".sData #product_"+trindex+"_type_"+indexc).val();
				if(val == ""){
					val = 0;
				}
				var ph= parseFloat(val);
				json += "{'typeid':"+indexc+",";
				json += "'inputval':"+ph+",";
				json += "},";
			}
		});
		
		json = json.substring(0,json.length-1);
		json += "]},";
	});
	json = json.substring(0,json.length-1);
	json += "]}";
	document.getElementById("retallPriceForm:strJSON").value = json;
}
function productCountclick(){
	if(confirm('确定保存吗？')){
		jquery("#typeInfo").val(1);
		saveJSON();
   	 	return true;
	}
	return false;
}

function saveInfo(){
	jquery("#typeInfo").val(0);
	saveJSON();
}

var TmpVal;
function onhover(obj){
	TmpVal=jquery(obj).val();
	jquery(obj).val("");
}
function onout(obj){
	if("" == jquery(obj).val()){
    	jquery(obj).val(TmpVal);
    }
}
function clearNoNum(obj){   
	obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  
	obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是. 
	obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.   
	obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
}
//]]>
</script>
<script type="text/javascript">
			    jquery('.selectpicker').selectpicker();
			</script>
</td>
	</ui:define>

</ui:composition>
