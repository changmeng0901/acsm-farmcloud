<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<f:view xmlns="http://www.w3.org/1999/xhtml"
   xmlns:ui="http://java.sun.com/jsf/facelets"
   xmlns:f="http://java.sun.com/jsf/core"
   xmlns:h="http://java.sun.com/jsf/html"
   xmlns:s="http://jboss.com/products/seam/taglib"
   xmlns:rich="http://richfaces.org/rich"
   xmlns:a="http://richfaces.org/a4j"
   contentType="text/html">
<html  xmlns="http://www.w3.org/1999/xhtml" lang="en" ng-app="app">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
            <meta http-equiv="pragma" content="no-cache"/>
      <title>
      	<s:fragment rendered="#{userHome.source ne 7 and userHome.source ne 8 and userHome.source ne 13 and userHome.source ne 14}">义田帮手简单实用的农场管理工具</s:fragment>
		<s:fragment rendered="#{userHome.source eq 7}">供销网全国绿色基地管理平台</s:fragment>
		<s:fragment rendered="#{userHome.source eq 8}">安蔬网全国绿色基地管理平台</s:fragment>
		<s:fragment rendered="#{userHome.source eq 13}">原州区农场智能管理与服务平台</s:fragment>
		<s:fragment rendered="#{userHome.source eq 14}">资源县农场智能管理与服务平台</s:fragment>
      </title>
      <link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/user/changePassword.css" />
      <script type="text/javascript" src="#{request.contextPath}/asset/js/jquery.js"></script>
     <style>
		 .password-header .as-logo {
		    float: left;
		    height: 69px;
		    margin-top: 17px;
		    vertical-align: top;
		}
		.password-header .gx-logo {
		    float: left;
		    height: 55px;
		    margin-top: 17px;
		    vertical-align: top;
		}
		.password-header .yz-logo {
		    float: left;
		    height: 30px;
		    margin-top: 25px;
		    vertical-align: top;
		    width: 360px;
		}
		.password-header .zy-logo {
		    float: left;
		    height: 30px;
		    margin-top: 25px;
		    vertical-align: top;
		    width: 370px;
		}
		</style>
   </head>
   <body>
    <!-- 头部 -->
    <div class="password-header-wap">
        <div class="password-header clear">
        	<s:fragment rendered="#{userHome.source eq 7}"><img class="gx-logo fl" src="#{request.contextPath}/asset/images/user/gx_password_logo.png" /></s:fragment>
        	<s:fragment rendered="#{userHome.source eq 8}"><img class="as-logo fl" src="#{request.contextPath}/asset/images/user/as_password_logo.png" /></s:fragment>
        	<s:fragment rendered="#{userHome.source eq 13}"><img class="yz-logo fl" src="#{request.contextPath}/asset/images/login/yz_logo.png" /></s:fragment>
        	<s:fragment rendered="#{userHome.source eq 14}">
        		<div class="zy-logo">
	        		<div class="fl" style="margin-top:-13px;margin-right: 5px;">
		        		<img style="width:50px" src="#{request.contextPath}/asset/images/login/ziyuan_logo.png" />
	        		</div>
	        		<div class="fl" >
		        		<img style="width:310px" src="#{request.contextPath}/asset/images/login/ziyuan_logo_txt.png" />
	        		</div>
        		</div>
        	</s:fragment>
            <s:fragment rendered="#{userHome.source ne 7 and userHome.source ne 8 and userHome.source ne 13  and userHome.source ne 14}">
	            <img class="h-logo fl" src="#{request.contextPath}/asset/images/user/changePassword_logo1.png" />
	            <span class="h-line"></span>
	            <p class="h-phone">400-8199-586</p>
            </s:fragment>          
        </div>
    </div>

    <!-- 主体内容 -->
    <div class="password-content-wap clear">
        <div class="password-content" style="top:50%">
            <strong class="c-ttl">
                <img src="#{request.contextPath}/asset/images/user/changePassword_ico1.jpg" /><p>找回密码</p>
            </strong>

            <div class="ct-main" style="height:360px;margin-top:10px;padding-top:25px;" >			  
                <!-- 默认找回 -->
                <div class="set-default">
                    <ul class="settab-hd clear">
                        <li class="items items1 s-cur fl">
                            <span></span>
                            <p class="s-txt">验证手机号</p>
                        </li>
                        <li class="items items2 fr">
                            <span></span>
                            <p class="s-txt">重置密码</p>
                        </li>
                    </ul>
                    <div class="settab-bd">
                        <!-- 验证手机号内容 -->
                        <div class="tab-con b-cur">
                            <ol class="ipt-list">
                                <li class="li-li1 li-tip">
                                    <div class="items" id="telDiv">
                                        <span class="put-ico">
                                            <img src="#{request.contextPath}/asset/images/user/changePassword_ico4.png" />
                                        </span>
                                        <input class="put-text" type="text" value="请输入您的手机号" id="telphone" name="phone"/>
                                    </div>
                                    <p style="display:none;" id="telErrorMsg">您输入的手机号不存在！</p>
                                </li>
                                 <li class="li-li2 li-tip">
                                    <div class="items" id="imgDiv" style="width:120px;">
                                        <span class="put-ico">
                                            <img src="#{request.contextPath}/asset/images/user/changePassword_ico5.png" />
                                        </span>
                                        <input class="put-text txt2" type="text" value="图片验证码" id="imgCode" style="width:80px;"/>
                                    </div>
                                    <img id="validCode" style="margin-left: 5px; margin-left: 5px;float: left; position: absolute;left: 124px;top: 0;  " src="#{request.contextPath}/ImageCode" width="64" height="32"/>
		                        	<a href="#" style=" position: absolute;float: left;left: 200px;top: 5px;width:50px;" onclick="document.getElementById('validCode').src = '#{request.contextPath}/ImageCode?p=' + new Date();return false;">
		                        		<font color="#1faeff">换一张</font> 
		                        	</a>
                                    <p style="display:none;" id="imgErrorMsg">图片验证码输入错误</p>
                                </li>
                                <li class="li-li2 li-tip">
                                    <div class="items" id="codeDiv">
                                        <span class="put-ico">
                                            <img src="#{request.contextPath}/asset/images/user/changePassword_ico5.png" />
                                        </span>
                                        <input class="put-text txt2" type="text" value="请输入短信验证码" id="smsCode"/>
                                        <button class="put-text txt3" type="button" id="smsCodeBtn" onclick="getSmsCode();">获取验证码</button>
                                        <p class="put-text txt3" id="smsCodeWait" style="cursor:default;display:none;">60秒后重试！</p>
                                    </div>
                                    <p style="display:none;" id="codeErrorMsg">验证码输入错误</p>
                                </li>
                                <li class="li-li3">
                                    <button class="find-btn" type="submit" onclick="findPsw();">找回密码</button>
                                </li>
                                <li class="li-li4">
                                    <a class="return_login" href="#{request.contextPath}/login.seam">返回登录</a>
                                </li>
                            </ol>
                        </div>
                        <!-- 重置密码内容 -->
                         <h:form id="pwdForm">
                        <div class="tab-con">
                            <ol class="ipt-list">
                                <li class="li-li1 li-tip">
                                    <div class="items" id="newPwdDiv">
                                        <span class="put-ico">
                                            <img src="#{request.contextPath}/asset/images/user/changePassword_ico6.png" />
                                        </span>
                                        <input id="desc_txt1" class="put-text" type="text" value="输入新密码"/>
                                        <input id="newPwd" name="lodpassword" class="put-text" type="password" style="display:none;"/>
                                    </div>
                                    <p style="display:none;" id="newPwdMsg">请输入新密码！</p>
                                </li>
                                <li class="li-li1 li-tip">
                                    <div class="items" id="confirmPwdDiv">
                                        <span class="put-ico">
                                            <img src="#{request.contextPath}/asset/images/user/changePassword_ico7.png" />
                                        </span>
                                        <input id="desc_txt2" class="put-text" placeholder="确认新密码" value="确认新密码"/>
                                        <input id="confirmPwd" name="newpassword" class="put-text" type="password" style="display:none;"/>
                                    </div>
                                    <p style="display:none;" id="confirmPwdMsg">两次密码输入不一致！</p>
                                </li>
                                <li class="li-li3">
                                    <a:commandButton id="submitPwdBtn" styleClass="find-btn" action="#{userHome.editPwd()}" value="确定" onclick="if(!submitPwd()) return false;" data="#{userHome.chongfu}" oncomplete="checkEnd(data)"/>
                                </li>
                                <li class="li-li4">
                                    <a class="return_login" href="#{request.contextPath}/login.seam">返回登录</a>
                                </li>
                            </ol>
                        </div>                                                        		
                </h:form>
                    </div>
                </div>
              	
              		
                <!-- 找回成功 -->
                <div class="set-success">
                    <div class="new-tip">
                        <p class="txt1">新密码设置成功！</p>
                        <p class="txt2">请牢记您新设置的密码。<a href="#{request.contextPath}/login.seam">返回登录</a></p>
                    </div>
                </div>
            </div>

            <span class="c-line-l"></span>
            <span class="c-line-r"></span>
        </div>
    </div>

    <!-- 脚部 -->
    <div class="password-footer-wap clear">
        <div class="password-footer">Copyright 北京奥科美技术服务有限公司</div>
    </div>
       <a:form>
         <a:jsFunction name="checkUserPhone" action="#{userHome.checkUserPhone()}" data="#{userHome.userMsg}" oncomplete="checkUserPhoneBack(data);">
      		<a:actionparam name="phone" assignTo="#{userHome.phone}"/>
      		<a:actionparam name="imgCode" assignTo="#{userHome.imgCode}"/>
        </a:jsFunction>
        <a:jsFunction name="sendCode" action="#{userHome.sendCode()}" data="#{userHome.message}" oncomplete="sendCodeBack(data);">
      		<a:actionparam name="phone" assignTo="#{userHome.phone}"/>
      		<a:actionparam name="imgCode" assignTo="#{userHome.imgCode}"/>
        </a:jsFunction>
        <a:jsFunction name="checkTelCode" action="#{userHome.checkTelCode()}" data="#{userHome.telCodeMsg}" oncomplete="checkTelCodeBack(data);">
      		<a:actionparam name="phone" assignTo="#{userHome.phone}"/>
      		<a:actionparam name="verify" assignTo="#{userHome.verify}"/>
        </a:jsFunction>
 	</a:form>  
</body>
</html>

<script type="text/javascript">
//<![CDATA[
jQuery = jQuery.noConflict();
jQuery(function(){
	var type='#{userHome.source}';
	if(type=='7'){//湖南供销用户
		jQuery(".return_login").attr("href","gongxiao.seam");
	}else if(type=='8'){//安蔬网用户
		jQuery(".return_login").attr("href","anshu.seam");
	}else if(type=='13'){//原州用户
		jQuery(".return_login").attr("href","yzLogin.seam");
	}else if(type=='14'){//资源县用户
		jQuery(".return_login").attr("href","ziyuanyouji.seam");
	}else{
		jQuery(".return_login").attr("href","login.seam");
	}
	/**
    // 验证手机号和重置密码tab切换
	jQuery('.settab-hd .items').each(function(index, elem) {
        jQuery(elem).click(function(event) {
            jQuery(elem).addClass('s-cur').siblings().removeClass('s-cur');
            jQuery('.settab-bd .tab-con').eq(index).addClass('b-cur').siblings().removeClass('b-cur');
        });
    });
    */
    // 文本框获取焦点和失去焦点状态变化
    jQuery('input[type=text]').focus(function(){
        var txt_val = this.defaultValue;
        if( jQuery(this).val() == txt_val ){
            jQuery(this).val('');
        }
        jQuery(this).css('color','#333');
    });
    jQuery('input[type=text]').blur(function(){
        var txt_val = this.defaultValue;
        if( jQuery(this).val() == '' ){
            jQuery(this).val( this.defaultValue );
            jQuery(this).css('color','#ccc');
        }else{
            jQuery(this).css('color','#333');
        }
    });
    jQuery('#desc_txt1').focus(function(){
		jQuery(this).hide();
		jQuery('#newPwd').show();
		jQuery('#newPwd').focus();	
	})
	jQuery('#newPwd').blur(function(){
		if( jQuery('#newPwd').val() == '' ){
			jQuery('#desc_txt1').show();
			jQuery('#newPwd').hide();	
		}
			
	})
	jQuery('#desc_txt2').focus(function(){
		jQuery(this).hide();
		jQuery('#confirmPwd').show();
		jQuery('#confirmPwd').focus();	
	})
	jQuery('#confirmPwd').blur(function(){
		if( jQuery('#confirmPwd').val() == '' ){
			jQuery('#desc_txt2').show();
			jQuery('#confirmPwd').hide();	
		}
			
	})
    // 计算password-content  垂直居中
	getHeight()
    function getHeight(){
        var oWindowH = jQuery(window).height() ;
        var oHeaderH = jQuery('.password-header-wap').outerHeight();
        var oFooterH = jQuery('.password-footer-wap').outerHeight() ;
        jQuery('.password-content-wap').css({
            'height' : oWindowH - oHeaderH-oFooterH
        });
    }
	
jQuery(window).resize(function(){
	getHeight()	
});
});

var re= /^(13[0-9]|15[012356789]|17[01236789]|18[0-9]|14[57])[0-9]{8}$/;
function checkPhone(){
	var tel = document.getElementById("telphone").value;
	if(""==tel || "请输入您的手机号"==tel){
		jQuery("#telErrorMsg").html("请输入手机号！");
		jQuery("#telErrorMsg").css("display","");
		jQuery("#telDiv").addClass("red-border");
		return false;
	}else if(!re.test(tel) || tel.length != 11){
		jQuery("#telErrorMsg").html("请输入正确的手机号！");
		jQuery("#telErrorMsg").css("display","");
		jQuery("#telDiv").addClass("red-border");
		return false;
	}
	jQuery("#telErrorMsg").css("display","none");
	jQuery("#telDiv").removeClass("red-border");
	var imgCode = document.getElementById("imgCode").value;
	if("" == imgCode || "图片验证码" == imgCode){
		jQuery("#imgErrorMsg").html("请输图片验证码！");
		jQuery("#imgErrorMsg").css("display","");
		jQuery("#imgDiv").addClass("red-border");
		return false;
	}
	jQuery("#imgErrorMsg").css("display","none");
	jQuery("#imgDiv").removeClass("red-border");
	return true;
}
/**
 * 获取验证码
 */
function getSmsCode(){
	var tel=jQuery("#telphone").val();
	var imgCode = document.getElementById("imgCode").value;
	if(checkPhone()){
		checkUserPhone(tel,imgCode);
	}
}

function findPsw(){
	var tel=jQuery("#telphone").val();
	var smsCode=jQuery("#smsCode").val();
	if(checkPhone()){
		if(""==smsCode || "请输入短信验证码"==smsCode){
			jQuery("#codeErrorMsg").html("请输入短信验证码！");
			jQuery("#codeErrorMsg").css("display","");
			jQuery("#codeDiv").addClass("red-border");
			return false;
		}else{
			checkTelCode(tel,smsCode);
		}
    }
}
function checkTelCodeBack(msg){
	if(""==msg){
		jQuery('.settab-hd .items').eq(0).removeClass("s-cur");		
		jQuery('.settab-bd .tab-con').eq(0).removeClass('b-cur')
		jQuery('.settab-hd .items').eq(1).addClass("s-cur");
		jQuery('.settab-bd .tab-con').eq(1).addClass('b-cur');	
	}else if("tel"==msg){
		jQuery("#telErrorMsg").html("您输入的手机号不存在！");
		jQuery("#telErrorMsg").css("display","");
		jQuery("#telDiv").addClass("red-border");
	}else if("code"==msg){
		jQuery("#codeErrorMsg").html("验证码输入错误！");
		jQuery("#codeErrorMsg").css("display","");
		jQuery("#codeDiv").addClass("red-border");
	}
}
function checkUserPhoneBack(msg){
	if(""!=msg){
		jQuery("#telErrorMsg").css("display","none");
		jQuery("#telDiv").removeClass("red-border");
		jQuery("#imgErrorMsg").css("display","none");
		jQuery("#imgDiv").removeClass("red-border");
		jQuery("#codeErrorMsg").css("display","none");
		if("请输入正确的图片验证码！"==msg){
			jQuery("#imgErrorMsg").html(msg);
			jQuery("#imgErrorMsg").css("display","");
			jQuery("#imgDiv").addClass("red-border");
			document.getElementById('validCode').src = '/ImageCode?p=' + new Date();
			return false;
		}else{
			jQuery("#telErrorMsg").html(msg);
			jQuery("#telErrorMsg").css("display","");
			jQuery("#telDiv").addClass("red-border");
			return false;
		}
	}else{
		jQuery("#telErrorMsg").css("display","none");
		jQuery("#telDiv").removeClass("red-border");
		var tel=jQuery("#telphone").val();
		var imgCode = document.getElementById("imgCode").value;
		sendCode(tel,imgCode);
		return true;
	}
	return true;
}
function sendCodeBack(msg){
	if(""==msg){
		time1=59;
		timer1= setInterval( userHandler , 1000);
		jQuery("#smsCodeBtn").css("display","none");
		jQuery("#smsCodeWait").css("display","");

		jQuery("#codeErrorMsg").css("display","none");
		return false;
	}else{
		jQuery("#smsCodeBtn").css("display","");
		jQuery("#smsCodeWait").css("display","none");
		jQuery("#smsCodeWait").html("60秒后重试！");
		
		jQuery("#imgErrorMsg").css("display","none");
		jQuery("#imgDiv").removeClass("red-border");
		jQuery("#codeErrorMsg").css("display","none");
		if(msg == "yzCode"){
			jQuery("#codeErrorMsg").css("display","none");
			jQuery("#imgErrorMsg").html("请输入正确的图片验证码！");
			jQuery("#imgErrorMsg").css("display","");
			jQuery("#imgDiv").addClass("red-border");
			document.getElementById('validCode').src = '/ImageCode?p=' + new Date();
		}else{
			jQuery("#codeErrorMsg").html(msg);
			jQuery("#codeErrorMsg").css("display","");
		}
		return true;
	}
}
var time1=0;
var timer1; 
var userHandler=function(){
	jQuery("#smsCodeWait").html(time1+"秒后重试！");
	time1=time1-1;
	if(time1==0){
		clearInterval(timer1);
		jQuery("#smsCodeBtn").css("display","");
		jQuery("#smsCodeWait").css("display","none");
		jQuery("#smsCodeWait").html("60秒后重试！");
	}
};
var passChe1 = /^[a-zA-Z0-9]+$/;
var passChe2 = /(^(.*\d+.*[a-zA-Z]+.*)$)|(^(.*[a-zA-Z]+.*\d+.*)$)/;
function submitPwd(){
	var tel=jQuery("#telphone").val();
	var newPwd = document.getElementById("newPwd").value;
	var confirmPwd=jQuery("#confirmPwd").val();
	var pwdLength=newPwd.length;
	if(""==newPwd || "输入新密码"==newPwd){
		jQuery("#newPwdMsg").html("请输入新密码！");
		jQuery("#newPwdMsg").css({"display":"","line-height":"34px"});
		jQuery("#newPwdDiv").addClass("red-border");
		return false;
	}else if(pwdLength<7 || !passChe1.test(newPwd) || !passChe2.test(newPwd)){
		jQuery("#newPwdMsg").html("密码长度必须大于6，并且只能由字母和数字组成！");
		jQuery("#newPwdMsg").css({"display":"","line-height":"17px"});
		jQuery("#newPwdDiv").addClass("red-border");
		return false;
	}else{
		jQuery("#newPwdMsg").css("display","none");
		jQuery("#newPwdDiv").removeClass("red-border");
	}
	if(""==confirmPwd || "确认新密码"==confirmPwd){
		jQuery("#confirmPwdMsg").html("请输入确认密码！");
		jQuery("#confirmPwdMsg").css("display","");
		jQuery("#confirmPwdDiv").addClass("red-border");
		return false;
	}else if(newPwd!=confirmPwd){
		jQuery("#confirmPwdMsg").html("两次密码输入不一致！");
		jQuery("#confirmPwdMsg").css("display","");
		jQuery("#confirmPwdDiv").addClass("red-border");
		return false;
	}else{
		jQuery("#confirmPwdMsg").css("display","none");
		jQuery("#confirmPwdDiv").removeClass("red-border");
	}
	return true;
	/**
	jQuery("#pwdForm\\:hidPhone").val(tel);
	jQuery("#pwdForm\\:hidLodpassword").val(newPwd);
	jQuery("#pwdForm\\:hidNewpassword").val(confirmPwd);
	jQuery("#pwdForm\\:submitPwdBtn").click(); 	
	*/
}
function checkEnd(msg){
	if(""==msg){
		jQuery(".set-default").css("display","none");
		jQuery(".set-success").css("display","block");
	}else if("tel"==msg){
		jQuery("#confirmPwdMsg").html("您输入的手机号不存在！");
		jQuery("#confirmPwdMsg").css("display","");
		jQuery("#confirmPwdDiv").addClass("red-border");
	}else if("pwd"==msg){
		jQuery("#confirmPwdMsg").html("密码输入有误！");
		jQuery("#confirmPwdMsg").css("display","");
		jQuery("#confirmPwdDiv").addClass("red-border");
	}
}
//]]>
</script>

</f:view>
