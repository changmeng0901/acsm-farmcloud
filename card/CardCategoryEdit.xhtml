<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    template="/layout/empty_template.xhtml">

	<ui:define name="body">
	<link type="text/css" rel="stylesheet" href="#{request.contextPath}/asset/css/settings/EnterpriseSettings.css" />
    <script type="text/javascript" src="#{request.contextPath}/asset/js/EnterpriseLeftMenu.js"></script>
    
	#{cardCategoryHome.wire()}
	<style>
		.form-control{float:left;}
		.titleH2{height:34px; line-height:34px; margin:0 0 10px 0; font-size:14px; font-weight:bold; clear:both;}
		.listGoods_con .tableModel{border-left: 1px solid #e1e1e1; border-right: 1px solid #e1e1e1; border-top: 1px solid #e1e1e1; border-radius: 10px 10px 0 0; border-collapse: separate;font-family: '微软雅黑'; color: #6c6a6b;}
		.listGoods_con .thead {border-radius: 5px 5px 0 0;}
		.listGoods_con .tableModel thead{border-radius: 10px 10px 0 0;}
		.listGoods_con .tableModel thead th:first-child{border-radius: 5px 0 0 0;}
		.listGoods_con .tableModel thead th:last-child{border-radius: 0 5px 0 0;}
		.listGoods_con .tableModel thead th {height: 42px; background: #f0f5fb; font-size: 14px; font-weight: normal; text-align: center; border-bottom: 1px solid #e1e1e1;}
		.listGoods_con .tableModel tbody td {height: 38px; text-align: center; border-bottom: 1px solid #e1e1e1;background-color: #fcfcfc;}
		.listGoods_con .tableFixed_scroll {height: 218px; border-left: 1px solid #e1e1e1; border-right: 1px solid #e1e1e1;overflow-y: scroll;}
		.listGoods_con .tbody {border-radius: 0; border: 0;}
		.listGoods_con .tfoot {border: 1px solid #e1e1e1; border-radius: 0 0 5px 5px; margin-top: -1px;}
		.listGoods_total {position: relative; padding: 15px; min-height: 24px;}
		.listGoods_total .qingk img {margin-right: 5px; margin-bottom: 4px;}
		.listGoods_total .qingk span {font-size: 16px; color: #428bca;}
		.listGoods_total .spzj{line-height:24px; font-size:14px;}
		.listGoods_total .spzj .codeEle {font-size:18px; color:#d40001;}
		.listGoods_total .spzj .num {font-size:18px; color:#d40001;}
		.numCount_block {display: inline-block; width: 86px; height: 22px; background: url(../asset/images/orderManage/singleManage_bg4.jpg) no-repeat; vertical-align: middle;}
		.numCount_block .minusOne {float: left;display: inline-block;width: 22px;height: 22px;cursor: pointer;}
		.numCount_block .inputText {float: left;display: inline-block;width: 42px;height: 22px;padding: 1px 0;cursor: pointer;}
		.numCount_block .inputText input {width: 100%;height: 20px;line-height: 20px;padding: 0 3px;border: 0;border-radius: 0;text-align: center;}
		.numCount_block .addOne {float: left;display: inline-block;width: 22px;height: 22px;cursor: pointer;}
	</style>
	<td valign="top">
                <div class="inbentory_file_main">
                <!--左侧二级导航 -->
                <div class="inbentory_level_wap">
                    <div class="inbentory_level">
                        <strong class="inben_first inben_first2">
                            <a href="javascript:;"><i class="icon_L icon_rkgl"></i>基础设置</a><b class="b_arrow"></b>
                        </strong>
                        <ol class="inben_second">
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/user/UpdateEnterpriseSettings.seam?enterpriseId=#{sessionTake.enterpriseInfoId}','_self')" >
                            	<i class="icon_sed"></i>企业设置                   	
                            </li>
                            <!-- 管理版和以前的版本（标准、白金...)显示 -->
                            <h:panelGroup rendered="#{sessionTake.nowVersionService.basicService.basicServiceId==10 or sessionTake.nowVersionService.basicService.serviceType eq 1}">
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/user/ModuleSettings.seam','_self')" ><i class="icon_sed"></i>模块配置</li>
                            </h:panelGroup>
                            <li class="sed_item sed_cur" onclick="window.open('#{request.contextPath}/dictionary/DataDicinfoList.seam','_self')" ><i class="icon_sed"></i>字段管理</li>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/user/EnterpriseCommunityList.seam','_self')" ><i class="icon_sed"></i>角色管理</li>
                            <s:fragment rendered="#{enterpriseInfoHome.enterpriseInfo.govState}">
	                        	<li class="sed_item" onclick="window.open('#{request.contextPath}/user/AuditInformationList.seam','_self')" ><i class="icon_sed"></i>审核信息</li>
	                        </s:fragment>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/system/RecycleInfoList_1.seam','_self')" ><i class="icon_sed"></i>回收站</li>
                        </ol>
                        <strong class="inben_first inben_first2">
                            <a href="javascript:;"><i class="icon_L icon_ckgl"></i>生产管理设置</a><b class="b_arrow"></b>
                        </strong>
                        <ol class="inben_second">
                            <h:panelGroup rendered="#{s:hasRole('certification')}">
                            	<li class="sed_item" onclick="window.open('#{request.contextPath}/map/CertificationList.seam','_self')" ><i class="icon_sed"></i>认证信息</li>
                            </h:panelGroup>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/message/TunnelGroupList.seam','_self')" ><i class="icon_sed"></i>分组管理</li>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/product/InputsInfoList.seam?goodsTypeInfoId=5','_self')" ><i class="icon_sed"></i>投入品信息</li>
                        </ol>
                        <strong class="inben_first inben_first2">
                            <a href="javascript:;"><i class="icon_L icon_zkgl"></i>销售管理设置</a><b class="b_arrow"></b>
                        </strong>
                        <ol class="inben_second">
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/product/GoodsInfoList.seam','_self')"><i class="icon_sed"></i>物料信息</li>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/product/ProductInfoList.seam','_self')" ><i class="icon_sed"></i>商品信息</li>
                        </ol>
                        <strong class="inben_first inben_first2">
                            <a href="javascript:;"><i class="icon_L icon_pdgl"></i>硬件管理设置</a><b class="b_arrow"></b>
                        </strong>
                        <ol class="inben_second">
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/device/DeviceList.seam','_self')"><i class="icon_sed"></i>设备管理</li>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/device/VideoList.seam','_self')" ><i class="icon_sed"></i>视频管理</li>
                            <li class="sed_item" onclick="window.open('#{request.contextPath}/farming/AmRfidInfoList.seam','_self')" ><i class="icon_sed"></i>RFID卡管理</li>
                        </ol>
                    </div>
                    <i class="collapse_btn"></i>
                </div>
                <!--左侧二级导航 -->
				<!--右侧 -->
                <div class="inbentory_content">
	<div class="box_back" id="login" style="display: none; z-index: 1000">
				<div id="login2"
					style="width: 60px; height: 60px; margin: 220px auto 0 auto;">
					<img src="../asset/images/loginda.gif" />
				</div>
			</div>
		<h:form id="driverInfo" enctype="multipart/form-data">
			<div aria-hidden="false" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade in w600na" style="display: none;">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
							<h4 class="modal-title" id="myModalLabel">提示框</h4>
						</div>
						<div class="modal-body">
							<span id="productMsg">*号部分为必填项！</span>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							<button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
						</div>
					</div>
				</div>
			</div>
			<div class="right_c">
				<div class="r_title">
					<div class="r_t_l"><font size="4">卡类型信息</font></div>
				</div>
				<div class="all_d3">
					<div class="all_da all_w01">
						<table>
							<tr>
								<td class="all_te">名称：</td>
								<td>
									<h:inputText id="name" styleClass="form-control nw221" value="#{cardCategoryHome.instance.name}"/>
									<span class="finput"  style="color:#FF0000">*</span>
								</td>
							</tr>
						</table>
					</div>
					<div class="all_da all_w01">
						<table>
							<tr>
								<td class="all_te">种类：</td>
								<td>
									<h:selectOneMenu styleClass="selectpicker" id="cardType" value="#{cardCategoryHome.instance.cardType}" immediate="true" onchange="changeCardType(this.value);">
										<f:selectItems value="#{cardConstant.getCardTypeList()}"/>
									</h:selectOneMenu>
		                   			<span class="finput" style="color:#FF0000;float:right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					
					<div class="all_da all_w01" id="giftTypeDiv">
						<table>
							<tr>
								<td class="all_te">分类：</td>
								<td>
									<h:selectOneMenu styleClass="selectpicker" id="giftType" value="#{cardCategoryHome.instance.giftType}" immediate="true" onchange="changeCardType2(this.value);" >
										<f:selectItems value="#{cardConstant.getCardGiftList()}"/>
									</h:selectOneMenu>
		                   			<span class="finput" style="color:#FF0000;float:right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					
					<div class="all_da all_w01" id="weightDiv">
						<table>
							<tr>
								<td class="all_te">单次可用重量：</td>
								<td>
									<h:inputText id="weight" styleClass="form-control nw221" value="#{cardCategoryHome.instance.weight}"/>
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">g</span><span class="finput"  style="color:#FF0000; float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					
					<div class="all_da all_w01" id="fluctuationsDiv">
						<table>
							<tr>
								<td class="all_te">浮动重量：</td>
								<td>
									<h:inputText id="fluctuations" styleClass="form-control nw221" value="#{cardCategoryHome.instance.fluctuations}"/>
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">g</span><span class="finput"  style="color:#FF0000; float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					
					<div class="all_da all_w01" id="expiryDateDiv">
						<table>
							<tr>
								<td class="all_te">有效期：</td>
								<td>
									<h:inputText id="expiryDate" styleClass="form-control nw221" value="#{cardCategoryHome.instance.expiryDate}"/>
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">月</span><span class="finput"  style="color:#FF0000; float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					<div class="all_da all_w01" id="remindDiv">
						<table>
							<tr>
								<td class="all_te">提醒：</td>
								<td>
									<h:inputText id="remind" class="form-control nw221" value="#{cardCategoryHome.instance.remind}" onfocus="if(this.value=='距到期前多少天提醒'){this.value=''}" onblur="if(this.value==''){this.value='距到期前多少天提醒'}"/>
<!-- 									<input type="text" id="remind" class="form-control nw221" value="#{cardCategoryHome.instance.remind}" onfocus="if(this.value=='请填写到期前提醒天数'){this.value=''}" onblur="if(this.value==''){this.value='请填写到期前提醒天数'}"/> -->
									
<!-- 									<h:inputText id="remind" styleClass="form-control nw221" value="#{cardCategoryHome.instance.remind}"/> -->
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">天</span><span class="finput"  style="color:#FF0000; float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					<div class="all_da all_w01" id="deliverNumDiv">
						<table>
							<tr>
								<td class="all_te">配送次数：</td>
								<td>
									<h:inputText id="deliverNum" styleClass="form-control nw221" value="#{cardCategoryHome.instance.deliverNum}"/>
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">次</span><span class="finput"  style="color:#FF0000;  float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					<div class="all_da all_w01" id="amountDiv">
						<table>
							<tr>
								<td class="all_te">卡金额：</td>
								<td>
									<h:inputText id="amount" styleClass="form-control nw221" value="#{cardCategoryHome.instance.amount}"/>
									<span style="font-size: 14px;vertical-align:middle;height: 30px;line-height: 30px;">元</span><span class="finput"  style="color:#FF0000; float: right;">*</span>
								</td>
							</tr>
						</table>
					</div>
					<div class="all_da all_w01" style="width:80%; display: block;">
						<table>
							<tr>
								<td class="all_te">描述：</td>
								<td colspan="3"><h:inputTextarea id="remark" styleClass="form-control nw420" rows="3" value="#{cardCategoryHome.instance.remark}"  /></td>
							</tr>
						</table>
					</div>
					<div class="clear"></div>
				</div>
				
				<h2 class="titleH2" style="margin-top:50px;" id="cartTitle">
					<span class="pr10 fl" style="display:block;height:30px; line-height:30px;">商品选择</span>
					<div class="fl">
						<select class="selectpicker" id="productInfoId" data-live-search="true">
							<a:repeat value="#{cardCategoryHome.productList}" var="_p">
								<option value="#{_p.productInfoId}">#{_p.productName}</option>
							</a:repeat>
						</select>
					</div>
					<button type="button" class="btn btn-success" onclick="addPorductAction();">添加</button>
				</h2>
			    <div class="listGoods_con" id="cartContent">
			    	<table class="tableModel thead" width="100%" cellpadding="0" cellspacing="0">
			      		<thead>
			      			<tr>
			      				<th style="width:20%">编号</th>
			      				<th style="width:15%">商品</th>
			      				<th style="width:15%">规格</th>
			      				<th style="width:15%">单价</th>
			      				<th style="width:20%">数量</th>
			      				<th style="width:15%">操作</th>
			      			</tr>
			      		</thead>
			    	</table>
			    	<s:div styleClass="tableFixed_scroll" style="border-bottom:1px solid #e1e1e1;" id="cartDiv">
			    		<table class="tableModel tbody" width="100%" cellpadding="0" cellspacing="0" id="cartTable">
			        	    <tbody>
			        	    	<a:repeat value="#{cardCategoryHome.cartProductList}" var="_cart">
			        	    		<tr class="odd" id="cartProductTr#{_cart.productInfoId}">
					        	        <td style="width:20%">#{_cart.productCode}</td> 
					        	        <td style="width:15%">#{_cart.productName}</td>
					        	        <td style="width:15%">#{_cart.goodsInfo.goodsSpec}</td>
					        	        <td style="width:15%">
					        	        	<span style="display: inline-block; vertical-align: middle; line-height: 22px;">￥
					        	        		<input id="productPrice#{_cart.productInfoId}" type="text" style=" display:inline-block; width:60px; height:22px; line-height:20px; margin-left:5px; padding:0 3px; border-radius:0; text-align: center; float:none;" class="form-control" value="#{_cart.productPrice}" onkeyup="calculate();"/>
				        	        		</span>
			        	        		</td>
					        	        <td style="width:20%">
					        	        	<div class="numCount_block">
												<span class="minusOne" onclick="modifyNum(#{_cart.productInfoId}, 1,this,event);"></span>
												<span class="inputText"><input id="productNum#{_cart.productInfoId}" type="text" class="form-control" value="#{_cart.pNum}" onkeyup="modifyNum(#{_cart.productInfoId}, 3,this,event);"></input></span>
												<span class="addOne" onclick="modifyNum(#{_cart.productInfoId}, 2,this,event);"></span>
											</div>
					        	        </td>
					        	        <td style="width:15%"><a href="javascript:void(0);" onclick="removeProductAction(#{_cart.productInfoId});">删除</a></td>
					        	    </tr>
			        	    	</a:repeat>
			        	    </tbody>
			        	</table>
			    	</s:div>
					<div class="tfoot mb20">
						<div class="listGoods_total">
							<div class="qingk fl"><a href="javascript:void(0);" onclick="removeProductAction(0);"><img src="../asset/images/orderManage/X.png"></img><span>清空购物车</span></a></div>
							<div class="spzj fr">
							<span class="fl">商品总价 :</span>
							<span class="codeEle fl">¥</span>
							<span class="num fl" id="totalPrice">0.00</span></div>
						</div>
					</div>
			    </div>
			    
				<table width="180" style="margin:35px auto 0 auto;">
					<tr>
						<td>
							<h:inputHidden id="productJsonHidden" value="#{cardCategoryHome.productJson}" />
							<h:commandButton id="persist"  styleClass="btn btn-primary" value="提交" action="#{cardCategoryHome.persist}" onclick="if(!submitAction()){return false;};" rendered="#{!cardCategoryHome.managed}"/>
							<h:commandButton id="update" styleClass="btn btn-primary" value="提交" action="#{cardCategoryHome.update}" onclick="if(!submitAction()){return false;};" rendered="#{cardCategoryHome.managed}"/>&#160;
							
							<h:outputText rendered="#{cardCategoryHome.goType ne 2}" >
							<s:button view="/card/CardCategoryList.xhtml" styleClass="btn btn-default" value="返回" id="bn_left6" style="margin-left:10px" >
								<f:param name="pageNum" value="#{cardCategoryHome.pageNum}" />
							</s:button>
							</h:outputText>
							<h:outputText rendered="#{cardCategoryHome.goType eq 2}" >
							<s:button view="/card/CardInfoAddEdit.xhtml" styleClass="btn btn-default" value="返回" id="cardAddbtn" style="margin-left:10px" >
								<f:param name="cardType" value="#{cardsInfoHome.cardType}" />
								<f:param name="msg" value="" />
							</s:button>
							</h:outputText>
							
						</td>
					</tr>
				</table> 
				<div class="clear"></div>
			</div>
			<div class="clear"></div>
		</h:form>
		
		<div aria-hidden="false" id="messageDiv" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" class="modal fade in w600na">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true"></span><span class="sr-only">Close</span></button>
						<h4 class="modal-title" id="messageTitle">提示</h4>
					</div>
					<div class="modal-body">
						<span id="messageValue"></span>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
					</div>
				</div>
			</div>
		</div>
		</div>
		</div>
	</td>
	<a:form>
  		<a:queue requestDelay="10" ignoreDupResponses="true"/>
		<a:jsFunction name="addProductCartFind" action="#{cardCategoryHome.addProductCartFind}" reRender="cartDiv" oncomplete="calculate();">
			<a:actionparam name="productInfoId" assignTo="#{cardCategoryHome.productInfoId}"/>
			<a:actionparam name="productJson" assignTo="#{cardCategoryHome.productJson}"/>
		</a:jsFunction>
		<a:jsFunction name="removeProductCartFind" action="#{cardCategoryHome.removeProductCartFind}" reRender="cartDiv" oncomplete="calculate();">
			<a:actionparam name="productInfoId" assignTo="#{cardCategoryHome.productInfoId}"/>
			<a:actionparam name="productJson" assignTo="#{cardCategoryHome.productJson}"/>
		</a:jsFunction>
	</a:form>
	<script type="text/javascript" src="#{request.contextPath}/asset/js/jquery.nicescroll.js"></script>
	<script type="text/javascript">
	//<![CDATA[
		var cartPorductJson;
		jQuery(function($) { 
			var remind="#{cardCategoryHome.instance.remind}";  //初始值
			if(remind==null || remind==""){
				jQuery("#driverInfo\\:remind").val("距到期前多少天提醒");
			}
		});
		jQuery(document).ready(function(){
			jQuery('.selectpicker').selectpicker();  // 下拉框控件
			var cardType = '#{cardCategoryHome.instance.cardType}';
			if(cardType == 0){
				cardType = 1;
				jQuery("#driverInfo\\:cardType").val(1);
				jQuery("#driverInfo\\:giftType").val(1);
			}
			
			jQuery("#driverInfo\\:cardType").selectpicker("refresh");
			jQuery("#driverInfo\\:giftType").selectpicker("refresh");
			changeCardType(cardType);
			calculate();
			jQuery("#driverInfo\\:cartDiv").niceScroll({cursorcolor:"#919191",cursorwidth:10,cursoropacitymax:0.7,touchbehavior:false,autohidemode:false}); 
		});

		//提交
		function submitAction(){
			joinResultJson();
			jQuery("#driverInfo\\:productJsonHidden").val(cartPorductJson);

			var cardCategoryName = jQuery("#driverInfo\\:name").val();
			var expiryDate = jQuery("#driverInfo\\:expiryDate").val();
			var remind = jQuery("#driverInfo\\:remind").val();
			var deliverNum = jQuery("#driverInfo\\:deliverNum").val();
			var amount = jQuery("#driverInfo\\:amount").val();
			var cardCategory=jQuery("#driverInfo\\:cardType").val();
			var giftType=jQuery("#driverInfo\\:giftType").val();

			var remark=jQuery("#driverInfo\\:remark").val();
			
			var weight=jQuery("#driverInfo\\:weight").val();
			var fluctuations=jQuery("#driverInfo\\:fluctuations").val();
			var reg = new RegExp("^-?\\d+$");
			
			if(cardCategory==1){
				if (expiryDate == null || expiryDate == '') {
					jQuery("#messageValue").html("有效期不能为空！");
					jQuery("#messageDiv").modal('show');
					return false;
				}else {
					if (expiryDate <= 0 ) {
						jQuery("#messageValue").html("有效期须大于0！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
					
					if(!reg.test(expiryDate)){
						jQuery("#messageValue").html("有效期只能为整数！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
				}
				if(cardCategoryName.length>20){
					jQuery("#messageValue").html("卡名称输入过长！");
					jQuery("#messageDiv").modal('show');
					return false;
				}
				if (remind == null || remind == ''|| remind=="距到期前多少天提醒") {
					jQuery("#messageValue").html("提醒不能为空！");
					jQuery("#messageDiv").modal('show');
					return false;
				}
				if(!reg.test(remind)){
					jQuery("#messageValue").html("提醒只能为整数！");
					jQuery("#messageDiv").modal('show');
					return false;
				}
				if (deliverNum == null || deliverNum == '') {
					jQuery("#messageValue").html("配送次数不能为空！");
					jQuery("#messageDiv").modal('show');
					return false;
				}

				if(!reg.test(deliverNum)){
					jQuery("#messageValue").html("配送次数只能为整数！");
					jQuery("#messageDiv").modal('show');
					return false;
				}
				if(giftType == 0){
					if(weight == null || weight == ''){
						jQuery("#messageValue").html("单次可用重量不能为空！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
					if(isNaN(weight)){
						jQuery("#messageValue").html("单次可用重量必须是数字！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
					if(fluctuations == null || fluctuations == ''){
						jQuery("#messageValue").html("浮动重量不能为空！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
					if(isNaN(fluctuations)){
						jQuery("#messageValue").html("浮动重量必须是数字！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
				}else{
					if (amount == null || amount == '') {
						jQuery("#messageValue").html("卡金额不能为空！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
					if(isNaN(amount)){
						jQuery("#messageValue").html("卡金额必须是数字！");
						jQuery("#messageDiv").modal('show');
						return false;
					}
				}
			}else{
				if (remind=="距到期前多少天提醒") {
					jQuery("#driverInfo\\:remind").val("");
				}
			}
			if(remark.length>500){
				jQuery("#messageValue").html("卡描述输入过长！");
				jQuery("#messageDiv").modal('show');
				return false;
			}
			if(cardCategoryName.length>20){
				jQuery("#messageValue").html("卡名称输入过长！");
				jQuery("#messageDiv").modal('show');
				return false;
			}
			if (cardCategoryName == null || cardCategoryName == '') {
				jQuery("#messageValue").html("卡类型名称不能为空！");
				jQuery("#messageDiv").modal('show');
				return false;
			}
			jQuery("#login").show();
			return true;
		}
		
		//添加商品
		function addPorductAction(){
			var productId = jQuery("#productInfoId").val();
			if(productId != null && productId != ''){
				joinResultJson();
				addProductCartFind(Number(productId), cartPorductJson);
			}
		}

		//删除商品 id=0 为清空购物车
		function removeProductAction(pId){
			joinResultJson();
			removeProductCartFind(Number(pId), cartPorductJson);
		}

		//拼接 保存购物车 json
		function joinResultJson(){
			var jsonStr = "[";
			jQuery("#cartTable tr").each(function(){
				if (this.id != null && this.id != '') {
					var cartProductTr = this.id;
					var productId = cartProductTr.replace("cartProductTr", "");
					var productNum = jQuery("#productNum" + productId).val();
					var productPrice = jQuery("#productPrice" + productId).val();
					jsonStr += "{";
					jsonStr += "productId:" + productId;
					jsonStr += ",productNum:" + productNum;
					jsonStr += ",productPrice:" + productPrice;
					jsonStr += "},";
				}
			});
			if (jsonStr != "[") {
				jsonStr = jsonStr.substring(0, jsonStr.length - 1);
			}
			jsonStr += "]";
			cartPorductJson = jsonStr;
		}

		//公共 计算价格
		function calculate(){
			var cartPrice = 0;
			jQuery("#cartTable tr").each(function(){
				if (this.id != null && this.id != '') {
					var orderProductTr = this.id;
					var productId = orderProductTr.replace("cartProductTr", "");
					var productNum = jQuery("#productNum" + productId).val();
					var productPrice = jQuery("#productPrice" + productId).val();
					if (productNum == null || productNum == '') {
						productNum = 1;
					}
					if (productPrice == null || productPrice == '') {
						productPrice = 0;
					}
					jQuery("#productNum" + productId).val(productNum);
					jQuery("#productPrice" + productId).val(productPrice);
					cartPrice += Number(productNum * productPrice);
				}
			});
			jQuery("#totalPrice").html(cartPrice.toFixed(2));
			jQuery("#driverInfo\\:cartDiv").niceScroll({cursorcolor:"#919191",cursorwidth:10,cursoropacitymax:0.7,touchbehavior:false,autohidemode:false}); 
		}

		//商品数量变化
// 		function clearNoNum(obj, event){
// 			var keyCode = event.keyCode;
// 			if (keyCode < 37 || keyCode > 40) {
// 				if(!(keyCode >=48 && keyCode <=57)){
// 					obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  
// 					obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是. 
// 					obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.   
// 					obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
// 				}
// 			}
// 		}
		
		//卡种类联动
		function changeCardType(cardType){
			if (cardType == 1) {
				jQuery("#deliverNumDiv").css("display", "");
				jQuery("#cartTitle").css("display", "");
				jQuery("#cartContent").css("display", "");
				jQuery("#expiryDateDiv").css("display", "");
				jQuery("#remindDiv").css("display", "");
				jQuery("#amountDiv").css("display", "");
				jQuery("#giftTypeDiv").css("display", "");

				var remind="#{cardCategoryHome.instance.remind}";  //初始值
				if(remind==null || remind==""){
					jQuery("#driverInfo\\:remind").val("距到期前多少天提醒");
				}
				
				changeCardType2(jQuery("#driverInfo\\:giftType").val());

			} else {
				jQuery("#deliverNumDiv").css("display", "none");
				jQuery("#cartTitle").css("display", "none");
				jQuery("#cartContent").css("display", "none");
				jQuery("#expiryDateDiv").css("display", "none");
				jQuery("#remindDiv").css("display", "none");
				jQuery("#driverInfo\\:deliverNum").val("");
				jQuery("#driverInfo\\:expiryDate").val("");
				jQuery("#driverInfo\\:remind").val("");
				jQuery("#amountDiv").css("display", "none");
				jQuery("#giftTypeDiv").css("display", "none");
				jQuery("#fluctuationsDiv").css("display", "none");
				jQuery("#weightDiv").css("display", "none");
			}
		}

		//礼品卡 卡分类联动
		function changeCardType2(cardType){
			if (cardType == 1) {
				jQuery("#deliverNumDiv").css("display", "");
				jQuery("#fluctuationsDiv").css("display", "none");
				jQuery("#weightDiv").css("display", "none");
				jQuery("#cartTitle").css("display", "");
				jQuery("#cartContent").css("display", "");
				jQuery("#amountDiv").css("display", "");
			} else {
				jQuery("#fluctuationsDiv").css("display", "");
				jQuery("#weightDiv").css("display", "");
				jQuery("#amountDiv").css("display", "none");
				jQuery("#cartTitle").css("display", "none");
				jQuery("#cartContent").css("display", "none");
			}
		}

		//商品数量 +-变化
		function modifyNum(productId, modifyType,obj,event){
			var productNum = jQuery("#productNum" + productId).val();
			if (modifyType == 1) {
				if (productNum > 1) {
					productNum = Number(productNum) - 1;
					jQuery("#productNum" + productId).val(productNum.toFixed(2));
				}
			} else if(modifyType == 2) {
				productNum = Number(productNum) + 1;
				jQuery("#productNum" + productId).val(productNum.toFixed(2));
			}else{
				var keyCode = event.keyCode;
				if (keyCode < 37 || keyCode > 40) {
					if(!(keyCode >=48 && keyCode <=57)){
						obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  
						obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是. 
						obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.   
						obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
					}
				}
			}
			calculate();
		}
			
	//]]>
	</script>
	</ui:define>
</ui:composition>
